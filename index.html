<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern Peace Agreement Dashboard</title>
  <!-- Import Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------------------
       Modern Global Styles
       --------------------------- */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      font-size: 0.9rem;
      background-color: #f7f8fa; /* very light gray */
      color: #333;
      line-height: 1.6;
    }
    .negotiability-frame {
      background-color: #fff8e1;
      border: 2px dashed #ff9800;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .negotiability-frame h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: #ff9800;
    }

    /* ---------------------------
       Container & Card Styles
       --------------------------- */
    .container {
      max-width: 1300px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-radius: 8px;
      display: flex;
      flex-direction: row;
      gap: 1rem;
    }

    /* ---------------------------
       Column Layout
       --------------------------- */
    #leftColumn, #centerColumn, #rightColumn {
      background-color: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.05);
    }
    #leftColumn, #rightColumn {
      flex: 1;
      min-width: 330px;
    }
    #centerColumn {
      flex: 2;
      box-shadow: 0 0 22px rgba(0,0,0,0.25); /* Even more obvious shadow */
    }
    /* Optional borders between columns */
    #leftColumn { border-right: 1px solid #e0e0e0; }
    #rightColumn { border-left: 1px solid #e0e0e0; }

    /* ---------------------------
       Headings & Text
       --------------------------- */
    h1, h2, h3 {
      font-weight: 500;
      color: #222;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    /* ---------------------------
       Subheader Enhancements
       --------------------------- */
    /* Left Column Subheaders */
    .section-block h2 {
      background-color: #e8efff;
      border-left: 4px solid #007bff;
      padding: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 500;
    }
    /* Center Column Treaty Subheaders */
    .treaty-section h3 {
      background-color: #f0f8ff;
      border-left: 4px solid #007bff;
      padding: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* ---------------------------
       Instructions Frame
       --------------------------- */
    #instructions {
      max-width: 1300px;
      margin: 1rem auto;
      padding: 1.5rem;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: justify;
    }
    #instructions p {
      margin-bottom: 1rem;
    }

    /* ---------------------------
       Modern Buttons
       --------------------------- */
    button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #2a6db6;
      color: #fff;
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
    }
    button:hover {
      background-color: #0069d9;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button:active {
      background-color: #005cbf;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ---------------------------
       List & Item Styling
       --------------------------- */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      margin: 0.5rem 0;
      padding: 0.75rem;
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      user-select: none;
    }
    li:hover {
      background-color: #f1f1f1;
    }

    /* ---------------------------
       Chart Container & Legend
       --------------------------- */
    #radarContainer {
      width: 100%;
      max-width: 580px;
      height: 400px;
      margin: 0 auto;
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1rem;
      box-sizing: border-box;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    #chartLegend {
      text-align: left;
      margin-top: 1rem;
    }
    #chartLegend ul li {
      margin-bottom: 0.5rem;
    }

    /* ---------------------------
       Highlight Animation
       --------------------------- */
    .highlight-negotiation {
      background-color: #fffbcc !important;
      border: 2px solid #ffcc00 !important;
    }

    /* Center headings styles for instructions */
    #instructions h1, #instructions h2 {
      text-align: center;
    }
  </style>
</head>
<body>

  <style>
    #instructions h1, #instructions h2 {
      text-align: center;
    }
  </style>
<!-- Instructions Frame -->
<div id="instructions"> 
  <h1>Peace Agreement Negotiation Tool</h1>
  <h2>Instructions</h2>
  <p>
    The radar chart serves as a visualization tool for assessing the viability of potential peace agreements between Ukraine and Russia. The chart can help negotiators identify which combinations of agreement items might achieve a workable balance that keeps all parties above their minimum requirements while maximizing areas of mutual satisfaction.
  </p>
  <p>
    When analyzing the chart, examine the relationship between satisfaction levels and negotiability scores for each stakeholder. High negotiability paired with moderate satisfaction suggests areas where parties have flexibility to make concessions, while low negotiability combined with high satisfaction often indicates core non-negotiable positions. For instance, if Russia shows high satisfaction but low negotiability, this suggests a hard line position, whereas Ukraine might show moderate satisfaction and higher negotiability, indicating room for compromise.
  </p>
  <p>
    The most promising paths to agreement appear where multiple parties show both above-threshold satisfaction and meaningful negotiability scores. Negotiators should focus on these overlapping zones of flexibility while ensuring no party's overall satisfaction drops below their minimum acceptable threshold, as this would likely cause them to abandon talks. By balancing these metrics, negotiators can identify which combinations of agreement items offer the best chance of achieving a stable agreement.
  </p>
  <div style="text-align: center;">
    <button onclick="loadPreset(1)">Preset 1</button>
    <button onclick="loadPreset(2)">Preset 2</button>
    <button onclick="loadPreset(3)">Preset 3</button>
  </div>
</div>

  <div class="container">
    <!-- LEFT COLUMN: Available Articles -->
    <div id="leftColumn">
      <h1>Available Negotiation Articles</h1>

      <!-- Territory and Sovereignty -->
      <div class="section-block">
        <h2>Territory and Sovereignty</h2>
        <ul data-section="territorial">
          <li data-id="1" draggable="true">1-Returning Ukrainian occupied portions of Kursk region</li>
          <li data-id="2" draggable="true">2-Returning all territories to Ukraine (1991 borders)</li>
          <li data-id="3" draggable="true">3-Maintaining Russian control over all occupied territories as of 2025</li>
          <li data-id="4" draggable="true">4-Maintaining Russian control over Zaporizhzhia and Kherson and territories occupied before 2022 (Crimea and parts of the DNR/LNR)</li>
          <li data-id="5" draggable="true">5-Ensuring international recognition of occupied territories as Russian territory</li>
        </ul>
      </div>

      <!-- Security Arrangements -->
      <div class="section-block">
        <h2>Security Arrangements</h2>
        <ul data-section="security">
          <li data-id="6" draggable="true">6-Ukraine renouncing its ambitions to join NATO</li>
          <li data-id="7" draggable="true">7-Granting Ukraine NATO membership</li>
          <li data-id="8" draggable="true">8-Legally binding bilateral defense agreements between Western nations and Ukraine</li>
          <li data-id="9" draggable="true">9-Imposing restrictions on Ukraine's military capabilities, including limits on troop numbers,  missile systems, and Western-supplied weapons</li>
          <li data-id="10" draggable="true">10-Developing Ukrainian military-industrial complex and defense industry</li>
          <li data-id="11" draggable="true">11-Keeping Ukrainian Army self-sufficient and technologically advanced, fully interoperable with NATO</li>
          <li data-id="12" draggable="true">12-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability</li>
        </ul>
      </div>

      <!-- Economic Conditions -->
      <div class="section-block">
        <h2>Economic Conditions</h2>
        <ul data-section="economic">
          <li data-id="13" draggable="true">13-Removal or easing of Western sanctions that have constrained Russia's economy</li>
          <li data-id="14" draggable="true">14-Keeping Western sanctions tight not to allow Russia rebuild its economy and improve miltech</li>
          <li data-id="15" draggable="true">15-Releasing Russian frozen assets, returning them to Russia</li>
          <li data-id="16" draggable="true">16-Using Russian frozen assets to rebuild Ukriane</li>
          <li data-id="17" draggable="true">17-Using Ukraine's gas transit infrastructure for European energy supplies from Russia</li>
          <li data-id="18" draggable="true">18-Allowing Western companies to use Ukrainain resources as raw materials</li>
        </ul>
      </div>

      <!-- Justice and Accountability -->
      <div class="section-block">
        <h2>Justice and Accountability</h2>
        <ul data-section="justice">
          <li data-id="19" draggable="true">19-Demanding accountability for Russian war crimes, including trials for those responsible for atrocities and crimes against humanity</li>
          <li data-id="20" draggable="true">20- Advocating for the safe return of forcibly deported Ukrainians, including  kidnapped children</li>
          <li data-id="21" draggable="true">21-Having elections in Ukraine before peace/ceasefire settlement</li>
        </ul>
      </div>
    </div>

    <!-- CENTER COLUMN: Official Peace Treaty -->
    <div id="centerColumn" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'center')">
      <div class="official-doc">
        <!-- Error Message Container -->
        <div id="errorMessage" style="display:none; margin-bottom:1rem; padding:0.75rem; background-color:#ffe6e6; border:1px solid #ff8888; text-align:center;"></div>
        <h1>Ukraine-Russia Peace Agreement Draft</h1>

        <!-- Negotiability Areas Frame -->
        <div id="negotiabilityFrame" class="negotiability-frame">
          <h3>Negotiability Areas</h3>
          <ul></ul>
        </div>

        <!-- Treaty Sections -->
        <div class="treaty-section" id="treaty-territorial">
          <h3>Territory and Sovereignty</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-security">
          <h3>Security Arrangement</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-economic">
          <h3>Economic Conditions</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-justice">
          <h3>Justice and Accountability</h3>
          <ul></ul>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Radar Chart -->
    <div id="rightColumn"
         ondragover="allowDrop(event)"
         ondrop="handleDrop(event, 'right')">
      <h1>Negotiation Analysis</h1>
      <div id="radarContainer">
        <canvas id="radarChart"></canvas>
        <!-- Optimize Draft Button -->
        <div style="text-align: center; width: 100%; margin-top: 1rem;">
          <button id="optimizeButton" onclick="optimizeDraft()">Optimize Draft</button>
        </div>
        <!-- Chart Legend -->
        <div id="chartLegend">
          <p><strong>Legend:</strong></p>
          <ul>
            <li><span style="color:rgb(10, 163, 97)">Satisfaction</span>: Green area representing overall satisfaction.</li>
            <li><span style="color:rgba(54,162,235,1)">Negotiability</span>: Blue area representing negotiability scores.</li>
            <li><span style="color:red; border-bottom: 1px dashed black;">Minimum Acceptable Threshold</span>: Red dashed line indicating the minimum acceptable level.</li>
          </ul>
        </div>
      </div>
    </div>
  </div><!-- end .container -->

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /***************************************************************************
     * 1. Data for each article:
     *    - <actor>_sat, <actor>_neg
     *    - Ukraine_pos, Russia_pos (used for icons)
     ***************************************************************************/
    const articlesInfo = {
      1:  {Ukraine_sat:9,Ukraine_neg:10,Russia_sat:10, Russia_neg:0,  USA_sat:8,USA_neg:10,EU_sat:7,EU_neg:10, Ukraine_pos:2, Russia_pos:1},
      2:  {Ukraine_sat:10,Ukraine_neg:10,Russia_sat:0, Russia_neg:0,  USA_sat:10,USA_neg:10,EU_sat:10,EU_neg:10, Ukraine_pos:1, Russia_pos:0},
      3:  {Ukraine_sat:1, Ukraine_neg:3, Russia_sat:8, Russia_neg:8,  USA_sat:4, USA_neg:9,  EU_sat:3, EU_neg:8,  Ukraine_pos:0, Russia_pos:1},
      4:  {Ukraine_sat:8, Ukraine_neg:8, Russia_sat:2, Russia_neg:2,  USA_sat:5, USA_neg:8,  EU_sat:5, EU_neg:8,  Ukraine_pos:2, Russia_pos:1},
      5:  {Ukraine_sat:0, Ukraine_neg:1, Russia_sat:10,Russia_neg:6,  USA_sat:1, USA_neg:2,  EU_sat:1, EU_neg:2,  Ukraine_pos:0, Russia_pos:1},
      6:  {Ukraine_sat:2, Ukraine_neg:7, Russia_sat:10,Russia_neg:0,  USA_sat:7, USA_neg:9,  EU_sat:7, EU_neg:9,  Ukraine_pos:2, Russia_pos:1},
      7:  {Ukraine_sat:10,Ukraine_neg:7, Russia_sat:0, Russia_neg:0,  USA_sat:4, USA_neg:10,EU_sat:6, EU_neg:9,  Ukraine_pos:1, Russia_pos:0},
      8:  {Ukraine_sat:8, Ukraine_neg:4, Russia_sat:3, Russia_neg:4,  USA_sat:7, USA_neg:8,  EU_sat:8, EU_neg:8,  Ukraine_pos:1, Russia_pos:0},
      9:  {Ukraine_sat:0, Ukraine_neg:0, Russia_sat:9, Russia_neg:5,  USA_sat:1, USA_neg:4,  EU_sat:0, EU_neg:3,  Ukraine_pos:0, Russia_pos:2},
      10: {Ukraine_sat:10,Ukraine_neg:4, Russia_sat:3, Russia_neg:4,  USA_sat:8, USA_neg:4,  EU_sat:10,EU_neg:4,  Ukraine_pos:1, Russia_pos:0},
      11: {Ukraine_sat:10,Ukraine_neg:1, Russia_sat:1, Russia_neg:2,  USA_sat:9, USA_neg:2,  EU_sat:10,EU_neg:1,  Ukraine_pos:1, Russia_pos:0},
      12: {Ukraine_sat:6, Ukraine_neg:5, Russia_sat:4, Russia_neg:8,  USA_sat:5, USA_neg:9,  EU_sat:8, EU_neg:9,  Ukraine_pos:1, Russia_pos:2},
      13: {Ukraine_sat:2, Ukraine_neg:2, Russia_sat:8, Russia_neg:5,  USA_sat:4, USA_neg:9,  EU_sat:5, EU_neg:6,  Ukraine_pos:0, Russia_pos:1},
      14: {Ukraine_sat:8, Ukraine_neg:3, Russia_sat:5, Russia_neg:6,  USA_sat:8, USA_neg:9,  EU_sat:8, EU_neg:2,  Ukraine_pos:1, Russia_pos:2},
      15: {Ukraine_sat:0, Ukraine_neg:1, Russia_sat:10,Russia_neg:4,  USA_sat:3, USA_neg:9,  EU_sat:3, EU_neg:4,  Ukraine_pos:0, Russia_pos:1},
      16: {Ukraine_sat:10,Ukraine_neg:4, Russia_sat:3, Russia_neg:0,  USA_sat:9, USA_neg:9,  EU_sat:9, EU_neg:6,  Ukraine_pos:1, Russia_pos:0},
      17: {Ukraine_sat:4, Ukraine_neg:7, Russia_sat:7,  Russia_neg:5,  USA_sat:4, USA_neg:9,  EU_sat:9, EU_neg:8,  Ukraine_pos:2, Russia_pos:2},
      18: {Ukraine_sat:5, Ukraine_neg:9, Russia_sat:4,  Russia_neg:6,  USA_sat:6, USA_neg:7,  EU_sat:6, EU_neg:8,  Ukraine_pos:1, Russia_pos:0},
      19: {Ukraine_sat:9, Ukraine_neg:7, Russia_sat:2,  Russia_neg:7,  USA_sat:7, USA_neg:9,  EU_sat:7, EU_neg:9,  Ukraine_pos:1, Russia_pos:2},
      20: {Ukraine_sat:8, Ukraine_neg:9, Russia_sat:3,  Russia_neg:8,  USA_sat:5, USA_neg:9,  EU_sat:5, EU_neg:9,  Ukraine_pos:2, Russia_pos:2},
      21: {Ukraine_sat:2, Ukraine_neg:6, Russia_sat:9,  Russia_neg:4,  USA_sat:10,USA_neg:6,  EU_sat:5, EU_neg:9,  Ukraine_pos:0, Russia_pos:1}
    };

    /***************************************************************************
     * 2. Icons for Ukraine/Russia positions: 1 => ✔, 0 => ✖, 2 => ✍ (or ?)
     ***************************************************************************/
    function getColoredIcon(pos) {
      if (pos === 1) {
        return '<span style="color: #66cc66;">\u2713</span>'; // ✔
      } else if (pos === 2) {
        return '<span style="color: #cccc00;">?</span>';      // Negotiable
      } else if (pos === 0) {
        return '<span style="color: #ff6666;">\u00d7</span>'; // ✖
      }
      return '';
    }

    function showErrorMessage(message) {
      const errorDiv = document.getElementById("errorMessage");
      if (errorDiv) {
        errorDiv.innerText = message;
        errorDiv.style.display = "block";
        // Hide the message after 3 seconds (or adjust as needed)
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 3000);
      }
    }

    /***************************************************************************
     * 3. Radar Chart initialization (Chart.js)
     ***************************************************************************/
    const thresholdPercentage = 0.5; // 50%
    const maxSatisfaction = 10;     
    const thresholdValue = thresholdPercentage * maxSatisfaction; // e.g., 5

    const radarData = {
      labels: ["Ukraine", "Russia", "USA", "Europe"],
      datasets: [
        {
          label: "Satisfaction",
          data: [0, 0, 0, 0],
          backgroundColor: "rgba(10, 163, 97,0.2)",
          borderColor: "rgba(10, 163, 97,1)",
          pointBackgroundColor: "rgba(10, 163, 97,1)",
          fill: true,
          borderWidth: 0.4,
          pointRadius: 0.7
        },
        {
          label: "Negotiability",
          data: [0, 0, 0, 0],
          backgroundColor: "rgba(54,162,235,0.2)",
          borderColor: "rgba(54,162,235,1)",
          pointBackgroundColor: "rgba(54,162,235,1)",
          fill: true,
          borderWidth: 0.4,
          pointRadius: 0.7
        },
        {
          label: "Minimum Acceptable Threshold",
          data: [thresholdValue, thresholdValue, thresholdValue, thresholdValue],
          borderColor: "red",
          pointBackgroundColor: "red",
          backgroundColor: "rgba(255,0,0,0)",
          fill: false,
          borderDash: [5, 5],
          borderWidth: 0.7,
          pointRadius: 0.5
        }
      ]
    };

    const radarChart = new Chart(document.getElementById('radarChart').getContext('2d'), {
      type: 'radar',
      data: radarData,
      options: {
        scales: {
          r: {
            pointLabels: {
              font: {
                size: 12,
                family: 'Roboto',
                style: 'bold'
              },
              color: '#000000'
            },
            ticks: {
              font: {
                size: 12,
                family: 'Roboto'
              },
              color: '#000000'
            }
          }
        }
      }
    });

    /***************************************************************************
     * 4. Drag & Drop handling
     ***************************************************************************/
    function allowDrop(event) {
      event.preventDefault();
    }

    function handleDragStart(event) {
      const li = event.target;
      const articleId = li.getAttribute("data-id");
      let origin, section;
      
      if (li.closest("#centerColumn")) {
        origin = "center";
        section = li.getAttribute("data-section");
      } else {
        origin = "left";
        const parentUl = li.closest("ul[data-section]");
        if (parentUl) {
          section = parentUl.getAttribute("data-section");
        }
      }
      
      const dragData = JSON.stringify({ articleId, origin, section });
      event.dataTransfer.setData("text/plain", dragData);
    }

    function handleDrop(event, dropZone) {
      event.preventDefault();
      const data = event.dataTransfer.getData("text/plain");
      if (!data) return;
      const { articleId, origin, section } = JSON.parse(data);

      if (dropZone === 'center') {
        if (origin === 'left') {
          moveArticleToCenter(articleId, section);
        }
      } else if (dropZone === 'left') {
        if (origin === 'center') {
          moveArticleToLeft(articleId, section);
        }
      } else if (dropZone === 'right') {
        console.log("Dropped on the right column; no action set by default.");
      }
    }

    const leftColumn = document.getElementById("leftColumn");
    leftColumn.ondragover = allowDrop;
    leftColumn.ondrop = (event) => {
      handleDrop(event, 'left');
    };

    document.querySelectorAll("#leftColumn li").forEach((li) => {
      li.addEventListener("dragstart", handleDragStart);
    });

    function makeLiDraggable(li) {
      li.setAttribute("draggable", "true");
      li.addEventListener("dragstart", handleDragStart);
    }

    /***************************************************************************
     * 5. Click-based move logic
     ***************************************************************************/
    leftColumn.addEventListener("click", (event) => {
      const li = event.target;
      if (li && li.tagName === "LI") {
        const articleId = li.getAttribute("data-id");
        const parentUl = li.closest("ul");
        const section = parentUl.getAttribute("data-section");
        moveArticleToCenter(articleId, section, li);
      }
    });

    const centerColumn = document.getElementById("centerColumn");
    centerColumn.addEventListener("click", (event) => {
      const li = event.target;
      if (li && li.tagName === "LI") {
        const articleId = li.getAttribute("data-id");
        const parentSectionId = li.closest(".treaty-section")?.id;
        if (!parentSectionId) return;
        const section = parentSectionId.replace("treaty-", "");
        moveArticleToLeft(articleId, section, li);
      }
    });

    /***************************************************************************
     * 6. Conflict rules
     ***************************************************************************/
    const conflictRules = {
      1: [2, 3, 4],
      2: [1, 3],
      3: [1, 2],
      4: [1],
      5: [6],
      6: [5],
      7: [],
      8: [10],
      9: [],
      10: [8],
      11: [],
      12: [13],
      13: [12],
      14: [15],
      15: [14],
      16: [],
      17: [],
      18: [],
      19: [],
      20: []
      // Add more if needed
    };

    function checkConflicts(newArticleId) {
      const centerArticleIds = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const id = li.getAttribute("data-id");
        if (id) centerArticleIds.push(parseInt(id, 10));
      });

      const newArticleConflicts = conflictRules[newArticleId] || [];
      for (let existingId of centerArticleIds) {
        if (newArticleConflicts.indexOf(existingId) !== -1) {
          return {
            conflict: true,
            message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
          };
        }
        const existingArticleConflicts = conflictRules[existingId] || [];
        if (existingArticleConflicts.indexOf(newArticleId) !== -1) {
          return {
            conflict: true,
            message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
          };
        }
      }
      return { conflict: false };
    }

    /***************************************************************************
     * 7. Move article from left => center
     ***************************************************************************/
    function moveArticleToCenter(articleId, section, clickedLi) {
      // Check for conflicts first
      const conflictCheck = checkConflicts(parseInt(articleId, 10));
      if (conflictCheck.conflict) {
        showErrorMessage(conflictCheck.message);
        return;
      }

      const info = articlesInfo[articleId];
      if (!info) return;

      let sourceLi = clickedLi;
      if (!sourceLi) {
        sourceLi = document.querySelector(
          `#leftColumn ul[data-section="${section}"] li[data-id="${articleId}"]`
        );
      }
      if (!sourceLi) return;

      const ukIcon = getColoredIcon(info.Ukraine_pos);
      const ruIcon = getColoredIcon(info.Russia_pos);

      const newLi = document.createElement("li");
      newLi.setAttribute("data-id", articleId);
      newLi.setAttribute("data-section", section);

      const mainTextDiv = document.createElement("div");
      mainTextDiv.textContent = sourceLi.textContent;

      const iconDiv = document.createElement("div");
      iconDiv.style.fontSize = "0.9rem";
      iconDiv.style.marginTop = "4px";
      iconDiv.style.color = "#666";
      iconDiv.style.fontStyle = "italic";
      iconDiv.innerHTML = `UKR: ${ukIcon} &nbsp;&nbsp; RUS: ${ruIcon}`;

      newLi.appendChild(mainTextDiv);
      newLi.appendChild(iconDiv);

      const treatyUl = document.querySelector(`#treaty-${section} ul`);
      if (!treatyUl) return;

      treatyUl.appendChild(newLi);
      sourceLi.remove();

      makeLiDraggable(newLi);
      recalcRadarChart();
    }

    /***************************************************************************
     * 8. Move article from center => left
     ***************************************************************************/
    function moveArticleToLeft(articleId, section, clickedLi) {
      const originalTitle = getOriginalTitle(articleId);
      if (!originalTitle) return;

      let sourceLi = clickedLi;
      if (!sourceLi) {
        sourceLi = document.querySelector(
          `#treaty-${section} ul li[data-id="${articleId}"]`
        );
      }
      if (!sourceLi) return;

      const leftUl = document.querySelector(
        `.section-block ul[data-section="${section}"]`
      );
      if (!leftUl) return;

      const newLi = document.createElement("li");
      newLi.setAttribute("data-id", articleId);
      newLi.textContent = originalTitle;
      newLi.setAttribute("draggable", "true");
      newLi.addEventListener("dragstart", handleDragStart);

      leftUl.appendChild(newLi);
      sourceLi.remove();

      makeLiDraggable(newLi);
      recalcRadarChart();
    }

    function getOriginalTitle(articleId) {
      const idNum = parseInt(articleId, 10);
      switch(idNum) {
        case 1:  return "1-Returning Ukrainian occupied portions of Kursk region";
        case 2:  return "2-Returning all territories to Ukraine (1991 borders)";
        case 3:  return "3-Maintaining Russian control over all occupied territories as of 2025";
        case 4:  return "4-Maintaining Russian control over Zaporizhzhia and Kherson and territories occupied before 2022 (Crimea and parts of the DNR/LNR)";
        case 5:  return "5-Ensuring international recognition of occupied territories as Russian territory";
        case 6:  return "6-Ukraine renouncing ambitions to join NATO";
        case 7:  return "7-Granting Ukraine NATO membership";
        case 8:  return "8-Legally binding bilateral defense agreements between Ukraine and Western nations";
        case 9:  return "9-Imposing restrictions on Ukraine's military capabilities, including limits on troop numbers,  missile systems, and Western-supplied weapons";
        case 10: return "10-Developing Ukrainian military-industrial complex and defense industry";
        case 11: return "11-Keeping Ukrainian Army self-sufficient and technologically advanced, fully interoperable with NATO";
        case 12: return "12-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability";
        case 13: return "13-Removal or easing of Western sanctions that have constrained Russia's economy";
        case 14: return "14-Keeping Western sanctions tight not to allow Russia rebuild its economy and improve miltech";
        case 15: return "15-Releasing Russian frozen assets, returning them to Russia";
        case 16: return "16-Using Russian frozen assets to rebuild Ukriane";
        case 17: return "17-Using Ukraine’s gas transit infrastructure for European energy supplies from Russia";
        case 18: return "18-Allowing Western companies to use Ukrainain resources as raw materials";
        case 19: return "19-Demanding accountability for Russian war crimes, including trials for those responsible for atrocities and crimes against humanity";
        case 20: return "20-Advocating for the safe return of forcibly deported Ukrainians, including  kidnapped children";
        case 21: return "21-Having elections in Ukraine before peace/ceasefire settlement";
        default: return "";
      }
    }

    /***************************************************************************
     * 9. Recalc the chart => gather all articles in the center
     ***************************************************************************/
    function recalcRadarChart() {
      let selectedIds = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const id = li.getAttribute("data-id");
        if (id) selectedIds.push(parseInt(id, 10));
      });
      if (selectedIds.length === 0) {
        radarChart.data.datasets[0].data = [0,0,0,0];
        radarChart.data.datasets[1].data = [0,0,0,0];
        radarChart.update();
        return;
      }

      let sumUkSat = 0, sumRuSat = 0, sumUsSat = 0, sumEuSat = 0;
      let sumUkNeg = 0, sumRuNeg = 0, sumUsNeg = 0, sumEuNeg = 0;
      selectedIds.forEach((id) => {
        const info = articlesInfo[id];
        if (!info) return;
        sumUkSat += info.Ukraine_sat;
        sumRuSat += info.Russia_sat;
        sumUsSat += info.USA_sat;
        sumEuSat += info.EU_sat;
        sumUkNeg += info.Ukraine_neg;
        sumRuNeg += info.Russia_neg;
        sumUsNeg += info.USA_neg;
        sumEuNeg += info.EU_neg;
      });
      const count = selectedIds.length;
      radarChart.data.datasets[0].data = [
        sumUkSat/count,
        sumRuSat/count,
        sumUsSat/count,
        sumEuSat/count
      ];
      radarChart.data.datasets[1].data = [
        sumUkNeg/count,
        sumRuNeg/count,
        sumUsNeg/count,
        sumEuNeg/count
      ];
      radarChart.update();
    }

    /***************************************************************************
     * 10. Presets for quick loading
     ***************************************************************************/
    const presets = {
      1: {
        territorial: [1, 4],
        security:    [6, 10, 11],
        economic:    [13, 16],
        justice:     [19, 20]
      },
      2: {
        territorial: [3],
        security:    [6, 8, 12],
        economic:    [14, 17, 16],
        justice:     [19, 20]
      },
      3: {
        territorial: [3, 5],
        security:    [7, 9],
        economic:    [16, 14, 18],
        justice:     [20, 21]
      }
    };

    function clearCenter() {
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const articleId = li.getAttribute("data-id");
        const parentSectionId = li.closest(".treaty-section").id;
        const section = parentSectionId.replace("treaty-", "");
        moveArticleToLeft(articleId, section, li);
      });
    }

    function loadPreset(presetNumber) {
      clearCenter();
      const preset = presets[presetNumber];
      if (!preset) return;
      for (let category in preset) {
        const articleIds = preset[category];
        articleIds.forEach(articleId => {
          moveArticleToCenter(articleId, category);
        });
      }
    }

    // Initial chart update
    recalcRadarChart();

    /***************************************************************************
     * 11. Optimize Draft logic
     ***************************************************************************/

    // Get all articles currently in the center
    function getCenterArticles() {
      const ids = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const idStr = li.getAttribute("data-id");
        if (idStr) ids.push(parseInt(idStr, 10));
      });
      return ids;
    }

    // Compute each stakeholder's average satisfaction
    function getStakeholdersData() {
      const centerIds = getCenterArticles();
      let sumUkSat=0, sumRuSat=0, sumUsSat=0, sumEuSat=0;
      const count = centerIds.length;
      centerIds.forEach((id) => {
        const info = articlesInfo[id];
        if (info) {
          sumUkSat += info.Ukraine_sat;
          sumRuSat += info.Russia_sat;
          sumUsSat += info.USA_sat;
          sumEuSat += info.EU_sat;
        }
      });
      return [
        { name: "Ukraine", sat: count ? sumUkSat / count : 0 },
        { name: "Russia",  sat: count ? sumRuSat / count : 0 },
        { name: "USA",     sat: count ? sumUsSat / count : 0 },
        { name: "Europe",  sat: count ? sumEuSat / count : 0 }
      ];
    }

    // Identify which stakeholder is below threshold or has the absolute lowest
    function findLowestStakeholder() {
      const data = getStakeholdersData();
      if (!data.length) return {};

      // 1) Check if Ukraine or Russia is below threshold
      let below = data.filter(d => 
        (d.name === "Ukraine" || d.name === "Russia") && d.sat < thresholdValue
      );
      if (below.length) {
        below.sort((a,b) => a.sat - b.sat);
        return { lowestStakeholder: below[0].name };
      }
      // 2) Then check if US or EU is below threshold
      below = data.filter(d => 
        (d.name === "USA" || d.name === "Europe") && d.sat < thresholdValue
      );
      if (below.length) {
        below.sort((a,b) => a.sat - b.sat);
        return { lowestStakeholder: below[0].name };
      }
      // 3) If none are below threshold, pick the absolute lowest with priority UA/RU
      data.sort((a,b) => a.sat - b.sat);
      let candidate = data.find(d => (d.name === "Ukraine" || d.name === "Russia"))
                    || data[0];
      return { lowestStakeholder: candidate.name };
    }

    // Among the other 3 stakeholders, pick one with highest satisfaction
    function findHighestSatisfactionStakeholder(excludeName) {
      const data = getStakeholdersData().filter(d => d.name !== excludeName);
      if (!data.length) return null;
      data.sort((a,b) => b.sat - a.sat);

      // "less important first (US, EU)"
      const americansOrEuropeans = data.filter(d => d.name === "USA" || d.name === "Europe");
      if (americansOrEuropeans.length) {
        americansOrEuropeans.sort((a,b) => b.sat - a.sat);
        return americansOrEuropeans[0].name;
      }
      // Otherwise pick the top from entire array
      return data[0].name;
    }

    // -------------- GLOBAL FUNCTION --------------
    // Moves highlight-negotiation items from center into Negotiability Frame
    function moveNegotiableItemsToFrame() {
      const negotiabilityFrame = document.querySelector("#negotiabilityFrame ul");
      const negotiableItems = document.querySelectorAll(".treaty-section ul li.highlight-negotiation");

      negotiableItems.forEach(li => {
        // Remove from current parent
        li.parentElement.removeChild(li);
        // Optionally style them in the frame
        li.style.color = "orange";
        // Move them into the negotiability frame
        negotiabilityFrame.appendChild(li);
      });
    }

    // Reorder items for a given "donor" stakeholder
    function reorderAndHighlightNegotiationItems(donorName) {
      const centerLis = document.querySelectorAll(".treaty-section ul li");
      const itemArray = [];

      // For flip animation (optional)
      const oldRects = new Map();
      centerLis.forEach(li => {
        const rect = li.getBoundingClientRect();
        oldRects.set(li, rect);
      });

      centerLis.forEach(li => {
        const idStr = li.getAttribute("data-id");
        if (!idStr) return;
        const id = parseInt(idStr, 10);
        const catSection = li.closest(".treaty-section").id.replace("treaty-", "");
        if (!articlesInfo[id]) return;

        let donorPos = 0;
        switch(donorName) {
          case "Ukraine": donorPos = articlesInfo[id].Ukraine_pos; break;
          case "Russia":  donorPos = articlesInfo[id].Russia_pos;  break;
          case "USA":     donorPos = 2; // For example treat as negotiable
            break;
          case "Europe":  donorPos = 2;
            break;
        }
        itemArray.push({
          liElement: li,
          articleId: id,
          position: donorPos,
          catSection
        });
      });

      // Sort so that negotiable items (pos=2) appear first
      function priority(pos) {
        // Lower number => higher priority
        return (pos === 2) ? 1 : (pos === 1 ? 2 : 3);
      }
      itemArray.sort((a, b) => priority(a.position) - priority(b.position));

      // Re-insert them in the original category UL in sorted order
      const sectionsMap = {};
      itemArray.forEach(item => {
        if (!sectionsMap[item.catSection]) {
          sectionsMap[item.catSection] = [];
        }
        sectionsMap[item.catSection].push(item);
      });

      for (let cat in sectionsMap) {
        const sortedItems = sectionsMap[cat];
        const parentUl = document.querySelector(`#treaty-${cat} ul`);
        if (!parentUl) continue;
        // Insert from first (top) to last
        sortedItems.forEach(obj => {
          parentUl.insertBefore(obj.liElement, parentUl.firstChild);
        });
      }

      // Highlight items that are "negotiable" for that donor (pos=2)
      itemArray.forEach(item => {
        if (item.position === 2) {
          item.liElement.classList.add("highlight-negotiation");
        } else {
          item.liElement.classList.remove("highlight-negotiation");
          item.liElement.style.color = "";
        }
      });

      // FLIP animation
      itemArray.forEach(item => {
        const li = item.liElement;
        const newRect = li.getBoundingClientRect();
        const oldRect = oldRects.get(li);
        const deltaX = oldRect.left - newRect.left;
        const deltaY = oldRect.top - newRect.top;
        li.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        li.style.transition = 'none';
        requestAnimationFrame(() => {
          li.style.transition = 'transform 0.3s ease-out';
          li.style.transform = '';
        });
      });
    }

    function optimizeDraft() {
      // 1) find stakeholder with lowest satisfaction
      const {lowestStakeholder} = findLowestStakeholder();
      const centerIds = getCenterArticles();
      if (!lowestStakeholder || !centerIds.length) {
        showErrorMessage("No articles or no stakeholder found to optimize.");
        return;
      }

      // 2) find a stakeholder with highest satisfaction who can yield
      const donorStakeholder = findHighestSatisfactionStakeholder(lowestStakeholder);
      if (!donorStakeholder) {
        showErrorMessage("No stakeholder found with high satisfaction.");
        return;
      }

      // 3) reorder & highlight items from donor
      reorderAndHighlightNegotiationItems(donorStakeholder);

      // 4) physically move any highlighted items to the negotiability frame
      moveNegotiableItemsToFrame();

      // 5) recalc chart
      recalcRadarChart();
      showErrorMessage(`Reordered items from ${donorStakeholder} to help ${lowestStakeholder}.`);
    }
  </script>

</body>
</html>
