<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>White Background Treaty with Radar Chart, Icons & Return-to-Left</title>
  <style>
    /* ---------------------------
       Basic page/body styling
       --------------------------- */
    body {
      margin: 0;
      padding: 0;
      font-family: "Georgia", serif;
      font-size: 0.9rem;
      background-color: #ffffff; /* A light gray to contrast with container */
      color: #333333; /* standard dark text */
    }

    /* ---------------------------
       Instructions frame styling
       --------------------------- */
    #instructions {
      max-width: 1300px;
      margin: 2rem auto;
      padding: 1rem;
      border: 2px solid #cccccc;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #instructions h2 {
      margin-top: 0;
    }
    /* ---------------------------
       Enhanced Preset Buttons
       --------------------------- */
       #instructions button {
      margin: 0.5rem 0.3rem;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      font-size: 1rem;
      font-family: "Georgia", serif;
      border-radius: 6px;
      border: none;
      background: linear-gradient(to bottom, #eee, #ccc);
      transition: background 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    #instructions button:hover {
      background: linear-gradient(to bottom, #ddd, #bbb);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #instructions button:active {
      background: linear-gradient(to bottom, #ccc, #aaa);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
    }

    /* ---------------------------
       Centered container
       --------------------------- */
    .container {
      max-width: 1300px;
      margin: 2rem auto;      /* This centers the container horizontally */
      padding: 1rem;         /* Some spacing around */
      background-color: #fff; /* White background for the content area */
      box-shadow: 0 0 15px rgba(0,0,0,0.1); /* Subtle shadow for style */
      border-radius: 8px;    /* Slight rounding of corners */
      display: flex;
      flex-direction: row;
    }

    /* Left column, center column, right column layout */
    #leftColumn {
      flex: 1;
      min-width: 260px;
      background-color: #f5f5f5;
      border-right: 2px solid #cccccc;
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
    }
    #centerColumn {
      flex: 2;
      background-color: #ffffff;
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
    }
    #rightColumn {
      flex: 1.2;
      border-left: 2px solid #cccccc;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Headings in columns */
    #leftColumn h1 {
      text-align: center;
      background-color: #eaeaea;
      color: #333;
      padding: 0.5rem;
      margin: 0 -1rem 1rem -1rem;
      font-size: 1.3rem;
    }
    #rightColumn h2 {
      margin-top: 0;
      text-align: center;
      background-color: #eaeaea;
      color: #333333;
      padding: 0.5rem;
      margin: 0 -1rem 1rem -1rem;
      font-size: 1.1rem;
      width: calc(100% + 2rem);
      box-sizing: border-box;
    }

    /* Section blocks in the left column */
    .section-block {
      margin-bottom: 1.5rem;
    }
    .section-block h2 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      background-color: #dddddd;
      padding: 0.3rem 0.5rem;
      border-left: 4px solid #666666;
    }
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    li {
      margin: 8px 0;
      padding: 8px;
      background-color: #ffffff;
      border: 1px solid #cccccc;
      border-radius: 4px;
      cursor: pointer;
      /* Disable text selection for better drag handling */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      transition: transform 0.3s ease-out; /* so we can animate the FLIP transform */
    }
    li:hover {
      background-color: #f0f0f0;
    }

    /* The official doc in the center */
    .official-doc {
      margin: 0 auto;
      margin-top: -1em;
      margin-bottom: -1em;
      padding: 1rem;
      border: 6px solid #4d2121;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background: #fafafa;
      width: 100%;
      max-width: 1000px;
      color: #333333;
      font-family: "Georgia", serif;
      overflow-y: auto;
    }
    .official-doc h2 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: #333333;
    }
    .treaty-section {
      margin-bottom: 1.5rem;
    }
    .treaty-section h3 {
      margin: 1rem 0 0.5rem;
      font-size: 1.1rem;
      text-decoration: underline;
    }
    .treaty-section ul {
      list-style-type: none;
      margin-left: 0;
      color: #444444;
    }
    .treaty-section ul li {
      margin-bottom: 0.5rem;
      font-size: 1rem;
      background-color: #ffffff;
      border: 1px solid #cccccc;
      border-radius: 4px;
      padding: 5px;
      margin: 5px 0;
      cursor: pointer;
      transition: transform 0.3s ease-out; /* so we can animate the FLIP transform */
    }
    .treaty-section ul li:hover {
      background-color: #f5f5f5;
    }

    /* Radar container in the right column */
    #radarContainer {
      width: 100%;
      max-width: 480px;
      height: 400px;
      margin: 0 auto;
      background-color: #ffffff;
      border: 1px solid #cccccc;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      padding: 0.5rem;
      box-sizing: border-box;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    
    /* Legend styling for the radar chart */
    #chartLegend {
      text-align: left;
      margin-top: 1rem;
      width: 100%;
    }
    #chartLegend ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #chartLegend li {
      margin-bottom: 0.5rem;
      transition: transform 0.3s ease-out; /* so we can animate the FLIP transform */
    }


/* =========================
       (2) HIGHLIGHT FOR NEGOTIATION
       ========================= */
       .highlight-negotiation {
  background-color: #ffffcc !important; /* highlight in light yellow */
  border: 2px solid #ffcc00 !important;
}
    /* =========================
       (3) The \"Optimize Draft\" button style
       ========================= */
    #optimizeButton {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-family: "Georgia", serif;
      border-radius: 6px;
      border: none;
      background: linear-gradient(to bottom, #eee, #ccc);
      transition: background 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    #optimizeButton:hover {
      background: linear-gradient(to bottom, #ddd, #bbb);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #optimizeButton:active {
      background: linear-gradient(to bottom, #ccc, #aaa);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
    }
  </style>
</head>
<body>







  <style>
    #instructions h1, #instructions h2 {
      text-align: center;
    }
  </style>
<!-- Instructions Frame -->
<div id="instructions"> 
  <h1>Peace Agreement Negotiation Tool</h1>
  <h2>Instructions</h2>
  <p>
    The radar chart serves as a visualization tool for assessing the viability of potential peace agreements between Ukraine and Russia. The chart can help negotiators identify which combinations of agreement items might achieve a workable balance that keeps all parties above their minimum requirements while maximizing areas of mutual satisfaction.
  </p>
  <p>
    When analyzing the chart, examine the relationship between satisfaction levels and negotiability scores for each stakeholder. High negotiability paired with moderate satisfaction suggests areas where parties have flexibility to make concessions, while low negotiability combined with high satisfaction often indicates core non-negotiable positions. For instance, if Russia shows high satisfaction but low negotiability, this suggests a hard line position, whereas Ukraine might show moderate satisfaction and higher negotiability, indicating room for compromise.
  </p>
  <p>
    The most promising paths to agreement appear where multiple parties show both above-threshold satisfaction and meaningful negotiability scores. Negotiators should focus on these overlapping zones of flexibility while ensuring no party's overall satisfaction drops below their minimum acceptable threshold, as this would likely cause them to abandon talks. By balancing these metrics, negotiators can identify which combinations of agreement items offer the best chance of achieving a stable agreement.
  </p>
  <button onclick="loadPreset(1)">Preset 1</button>
  <button onclick="loadPreset(2)">Preset 2</button>
  <button onclick="loadPreset(3)">Preset 3</button>
</div>



<div class="container">

  <!-- LEFT COLUMN: Available Articles -->
  <div id="leftColumn">
    <h1>Available Negotiation Articles</h1>

    <!-- Territorial Gains -->
    <div class="section-block">
      <h2>Territory and Sovereignty</h2>
      <ul data-section="territorial">
        <li data-id="1" draggable="true">1-Returning Ukrainian occupied portions of Kursk region.</li>
        <li data-id="2" draggable="true">2-Returning all territories to Ukraine (1991 borders)</li>
        <li data-id="3" draggable="true">3-Maintaining Russian control as of 2025</li>
        <li data-id="4" draggable="true">4-Maintaining Russian control pre-2022 (Crimea, etc.)</li>
        <li data-id="5" draggable="true">5-International recognition of occupied territories</li>
      </ul>
    </div>

    <!-- Security Arrangements -->
    <div class="section-block">
      <h2>Security Arrangements</h2>
      <ul data-section="security">
        <li data-id="6" draggable="true">6-Ukraine renouncing ambitions to join NATO</li>
        <li data-id="7" draggable="true">7-Granting Ukraine NATO membership</li>
        <li data-id="8" draggable="true">8-Legally binding bilateral defense agreements</li>
        <li data-id="9" draggable="true">9-Imposing restrictions on Ukraine’s military...</li>
        <li data-id="10" draggable="true">10-Developing Ukrainian military-industrial complex</li>
        <li data-id="11" draggable="true">11-Keeping Ukrainian Army advanced & NATO-compatible</li>
        <li data-id="12" draggable="true">12-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability</li>
      </ul>
    </div>

 
    <!-- Sanctions on Russia -->
    <div class="section-block">
      <h2>Economic Conditions</h2>
      <ul data-section="economic">
        <li data-id="13" draggable="true">13-Removal/easing of Western sanctions</li>
        <li data-id="14" draggable="true">14-Keeping Western sanctions tight</li>
        <li data-id="15" draggable="true">15-Releasing Russian frozen assets</li>
        <li data-id="16" draggable="true">16-Using Russian frozen assets to rebuild Ukraine</li>
        <li data-id="17" draggable="true">17-Using Ukraine’s gas transit for EU supplies</li>
        <li data-id="18" draggable="true">18-Allowing Western companies to use resources</li>
      </ul>
    </div>


    <!-- Justice and Accountability -->
    <div class="section-block">
      <h2>Justice and Accountability</h2>
      <ul data-section="justice">
        <li data-id="19" draggable="true">19-Demanding accountability for Russian war crimes</li>
        <li data-id="20" draggable="true">20-Advocating safe return of deported Ukrainians</li>
        <li data-id="21" draggable="true">21-Having elections in Ukraine before peace settlement</li>
      </ul>
    </div>
  </div>

  <!-- CENTER COLUMN: Official Peace Treaty -->
  <div id="centerColumn"
  ondragover="allowDrop(event)"
  ondrop="handleDrop(event, 'center')">
  <div class="official-doc">
  <!-- Error Message Container -->
  <div id="errorMessage" style="display:none; margin-bottom:1rem; padding:0.5rem; background-color:#ffdddd; border:1px solid #ff8888; text-align:center;"></div>
 
      <h2>Ukraine-Russia Peace Agreement Draft</h2>

      <!-- Standard Preamble -->
      <p>Below is a set of key negotiated terms that define this peace agreement:</p>

      <!-- Territorial Gains -->
      <div class="treaty-section" id="treaty-territorial">
        <h3>Territory and Sovereignty</h3>
        <ul></ul>
      </div>

      <!-- Security Arrangements -->
      <div class="treaty-section" id="treaty-security">
        <h3>Security Arrangement</h3>
        <ul></ul>
      </div>

      <!-- Ukraine's Military Capacity -->
      <div class="treaty-section" id="treaty-economic">
        <h3>Economic Conditions</h3>
        <ul></ul>
      </div>

      <!-- Justice and Accountability -->
      <div class="treaty-section" id="treaty-justice">
        <h3>Justice and Accountability</h3>
        <ul></ul>
      </div>

 
    </div>
  </div>

  <!-- RIGHT COLUMN: Radar Chart -->
  <div id="rightColumn"
       ondragover="allowDrop(event)"
       ondrop="handleDrop(event, 'right')">
    <h2>Negotiation Analysis</h2>
    <div id="radarContainer">
      <canvas id="radarChart"></canvas>
      <!-- Chart Legend -->
       
      <div id="chartLegend">
        <p><strong>Legend:</strong></p>
        <ul>
          <li><span style="color:rgb(10, 163, 97)">Satisfaction</span>: Green area representing overall satisfaction.</li>
          <li><span style="color:rgba(54,162,235,1)">Negotiability</span>: Blue area representing negotiability scores.</li>
          <li><span style="color:red; border-bottom: 1px dashed black;">Minimum Acceptable Threshold</span>: Red dashed line indicating the minimum acceptable level.</li>
        </ul>
        <!-- (6) The new \"Optimize Draft\" button under the radar chart -->
        <div style="text-align: center; width: 100%; margin-top: 1rem;"></div>
        <button id="optimizeButton" onclick="optimizeDraft()">Optimize Draft</button>
        </div>
        
      </div>
    </div>
  </div>
</div><!-- end .container -->


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  /***************************************************************************
   * 1. Data for each article:
   *    - <actor>_sat, <actor>_neg
   *    - Ukraine_pos, Russia_pos (used for icons)
   ***************************************************************************/
  const articlesInfo = {
    1:  {Ukraine_sat:9,Ukraine_neg:10,Russia_sat:10, Russia_neg:0,  USA_sat:8,USA_neg:10,EU_sat:7,EU_neg:10, Ukraine_pos:2, Russia_pos:1},
    2:  {Ukraine_sat:10,Ukraine_neg:10,Russia_sat:0, Russia_neg:0,  USA_sat:10,USA_neg:10,EU_sat:10,EU_neg:10, Ukraine_pos:1, Russia_pos:0},
    3:  {Ukraine_sat:1, Ukraine_neg:3, Russia_sat:8, Russia_neg:8,  USA_sat:4, USA_neg:9,  EU_sat:3, EU_neg:8,  Ukraine_pos:0, Russia_pos:1},
    4:  {Ukraine_sat:8, Ukraine_neg:8, Russia_sat:2, Russia_neg:2,  USA_sat:5, USA_neg:8,  EU_sat:5, EU_neg:8,  Ukraine_pos:2, Russia_pos:1},
    5:  {Ukraine_sat:0, Ukraine_neg:1, Russia_sat:10,Russia_neg:6,  USA_sat:1, USA_neg:2,  EU_sat:1, EU_neg:2,  Ukraine_pos:0, Russia_pos:1},
    6:  {Ukraine_sat:2, Ukraine_neg:7, Russia_sat:10,Russia_neg:0,  USA_sat:7, USA_neg:9,  EU_sat:7, EU_neg:9,  Ukraine_pos:2, Russia_pos:1},
    7:  {Ukraine_sat:10,Ukraine_neg:7, Russia_sat:0, Russia_neg:0,  USA_sat:4, USA_neg:10,EU_sat:6, EU_neg:9,  Ukraine_pos:1, Russia_pos:0},
    8:  {Ukraine_sat:8, Ukraine_neg:4, Russia_sat:3, Russia_neg:4,  USA_sat:7, USA_neg:8,  EU_sat:8, EU_neg:8,  Ukraine_pos:1, Russia_pos:0},
    9:  {Ukraine_sat:0, Ukraine_neg:0, Russia_sat:9, Russia_neg:5,  USA_sat:1, USA_neg:4,  EU_sat:0, EU_neg:3,  Ukraine_pos:0, Russia_pos:2},
    10:  {Ukraine_sat:10,Ukraine_neg:4, Russia_sat:3, Russia_neg:4,  USA_sat:8, USA_neg:4,  EU_sat:10,EU_neg:4,  Ukraine_pos:1, Russia_pos:0},
    11: {Ukraine_sat:10,Ukraine_neg:1, Russia_sat:1, Russia_neg:2,  USA_sat:9, USA_neg:2,  EU_sat:10,EU_neg:1,  Ukraine_pos:1, Russia_pos:0},
    12: {Ukraine_sat:6, Ukraine_neg:5, Russia_sat:4, Russia_neg:8,  USA_sat:5, USA_neg:9,  EU_sat:8, EU_neg:9,  Ukraine_pos:1, Russia_pos:2},
    13: {Ukraine_sat:2, Ukraine_neg:2, Russia_sat:8, Russia_neg:5,  USA_sat:4, USA_neg:9,  EU_sat:5, EU_neg:6,  Ukraine_pos:0, Russia_pos:1},
    14: {Ukraine_sat:8, Ukraine_neg:3, Russia_sat:5, Russia_neg:6,  USA_sat:8, USA_neg:9,  EU_sat:8, EU_neg:2,  Ukraine_pos:1, Russia_pos:2},
    15: {Ukraine_sat:0, Ukraine_neg:1, Russia_sat:10,Russia_neg:4,  USA_sat:3, USA_neg:9,  EU_sat:3, EU_neg:4,  Ukraine_pos:0, Russia_pos:1},
    16: {Ukraine_sat:10,Ukraine_neg:4, Russia_sat:3, Russia_neg:0,  USA_sat:9, USA_neg:9,  EU_sat:9, EU_neg:6,  Ukraine_pos:1, Russia_pos:0},
    17: {Ukraine_sat:4, Ukraine_neg:7, Russia_sat:7,  Russia_neg:5,  USA_sat:4, USA_neg:9,  EU_sat:9, EU_neg:8,  Ukraine_pos:2, Russia_pos:2},
    18: {Ukraine_sat:5, Ukraine_neg:9, Russia_sat:4,  Russia_neg:6,  USA_sat:6, USA_neg:7,  EU_sat:6, EU_neg:8,  Ukraine_pos:1, Russia_pos:0},
    19: {Ukraine_sat:9, Ukraine_neg:7, Russia_sat:2,  Russia_neg:7,  USA_sat:7, USA_neg:9,  EU_sat:7, EU_neg:9,  Ukraine_pos:1, Russia_pos:2},
    20: {Ukraine_sat:8, Ukraine_neg:9, Russia_sat:3,  Russia_neg:8,  USA_sat:5, USA_neg:9,  EU_sat:5, EU_neg:9,  Ukraine_pos:2, Russia_pos:2},
    21: {Ukraine_sat:2, Ukraine_neg:6, Russia_sat:9,  Russia_neg:4,  USA_sat:10,USA_neg:6,  EU_sat:5,  EU_neg:9,  Ukraine_pos:0, Russia_pos:1}
  };

  /***************************************************************************
   * 2. Icons for Ukraine/Russia positions: 1 => ✔, 0 => ✖, 2 => ✍ (or anything)
   ***************************************************************************/
  function getColoredIcon(pos) {
    if (pos === 1) {
      return '<span style="color: #66cc66;">\u2713</span>'; // ✔
    } else if (pos === 2) {
      return '<span style="color: #cccc00;">?</span>';      // ?
    } else if (pos === 0) {
      return '<span style="color: #ff6666;">\u00d7</span>'; // ✖
    }
    return '';
  }
  function showErrorMessage(message) {
  const errorDiv = document.getElementById("errorMessage");
  if (errorDiv) {
    errorDiv.innerText = message;
    errorDiv.style.display = "block";
    // Hide the message after 3 seconds (or adjust as needed)
    setTimeout(() => {
      errorDiv.style.display = "none";
    }, 3000);
  }
}
  /***************************************************************************
   * 3. Radar Chart initialization (Chart.js)
   ***************************************************************************/
  // Define threshold parameters:
  const thresholdPercentage = 0.5; // 60%
  const maxSatisfaction = 10;      // Maximum satisfaction per article (assumed)
  const thresholdValue = thresholdPercentage * maxSatisfaction; // e.g., 6

  const radarData = {
    labels: ["Ukraine", "Russia", "USA", "Europe"],
    datasets: [
      {
        label: "Satisfaction",
        data: [0, 0, 0, 0],
        backgroundColor: "rgba(10, 163, 97,0.2)", // greenish tint can be adjusted
        borderColor: "rgba(10, 163, 97,1)",
        pointBackgroundColor: "rgba(10, 163, 97,1)",
        fill: true,
        borderWidth: 0.4,
        pointRadius: 0.7


      },
      {
        label: "Negotiability",
        data: [0, 0, 0, 0],
        backgroundColor: "rgba(54,162,235,0.2)",
        borderColor: "rgba(54,162,235,1)",
        pointBackgroundColor: "rgba(54,162,235,1)",
        fill: true,
        borderWidth: 0.4,
        pointRadius: 0.7
      },
      {
        label: "Minimum Acceptable Threshold",
        data: [thresholdValue, thresholdValue, thresholdValue, thresholdValue],
        borderColor: "red",
        pointBackgroundColor: "red",
        backgroundColor: "rgba(255,0,0,0)", // no fill
        fill: false,
        borderDash: [5, 5],
        borderWidth: 0.7,
        pointRadius: 0.5 // smaller points
        // thinner line
      }
    ]
  };
  const radarChart = new Chart(document.getElementById('radarChart').getContext('2d'), {
    type: 'radar',
    data: radarData,
    options: {
        scale: {
            pointLabels: {
                fontSize: 14, // Increase font size
                fontColor: 'black', // Change font color to black
                fontStyle: 'bold' // Make labels bold
            },
            ticks: {
                fontSize: 12, // Increase font size for ticks
                fontColor: 'black' // Change font color for ticks to black
            }
        }
    }
});
  /***************************************************************************
   * 4. Drag & Drop handling
   ***************************************************************************/
  function allowDrop(event) {
    event.preventDefault();
  }

  function handleDragStart(event) {
    const li = event.target;
    const articleId = li.getAttribute("data-id");
    let origin, section;
    
    if (li.closest("#centerColumn")) {
      origin = "center";
      section = li.getAttribute("data-section"); 
    } else {
      origin = "left";
      const parentUl = li.closest("ul[data-section]");
      if (parentUl) {
        section = parentUl.getAttribute("data-section");
      }
    }
    
    const dragData = JSON.stringify({ articleId, origin, section });
    event.dataTransfer.setData("text/plain", dragData);
  }

  function handleDrop(event, dropZone) {
    event.preventDefault();
    const data = event.dataTransfer.getData("text/plain");
    if (!data) return;
    const { articleId, origin, section } = JSON.parse(data);

    if (dropZone === 'center') {
      if (origin === 'left') {
        moveArticleToCenter(articleId, section);
      }
    } else if (dropZone === 'left') {
      if (origin === 'center') {
        moveArticleToLeft(articleId, section);
      }
    } else if (dropZone === 'right') {
      console.log("Dropped on the right column; no action set by default.");
    } else {
      console.log("Dropped on unknown zone:", dropZone);
    }
  }

  // Mark left column as drop zone
  const leftColumn = document.getElementById("leftColumn");
  leftColumn.ondragover = allowDrop;
  leftColumn.ondrop = (event) => {
    handleDrop(event, 'left');
  };

  // Attach dragstart to all existing LIs in left column
  document.querySelectorAll("#leftColumn li").forEach((li) => {
    li.addEventListener("dragstart", handleDragStart);
  });

  // Make newly created LIs draggable
  function makeLiDraggable(li) {
    li.setAttribute("draggable", "true");
    li.addEventListener("dragstart", handleDragStart);
  }

  /***************************************************************************
   * 5. Click-based move logic
   ***************************************************************************/
  leftColumn.addEventListener("click", (event) => {
    const li = event.target;
    if (li && li.tagName === "LI") {
      const articleId = li.getAttribute("data-id");
      const parentUl = li.closest("ul");
      const section = parentUl.getAttribute("data-section");
      moveArticleToCenter(articleId, section, li);
    }
  });

  const centerColumn = document.getElementById("centerColumn");
  centerColumn.addEventListener("click", (event) => {
    const li = event.target;
    if (li && li.tagName === "LI") {
      const articleId = li.getAttribute("data-id");
      const parentSectionId = li.closest(".treaty-section").id;
      const section = parentSectionId.replace("treaty-", "");
      moveArticleToLeft(articleId, section, li);
    }
  });




  // Define conflict rules: each key has an array of incompatible article IDs.
const conflictRules = {
  1: [2, 3, 4],
  2: [1, 3],
  3: [1, 2],
  4: [1],
  5: [6],
  6: [5],
  7: [],
  8: [10],
  9: [],
  10: [8],
  11: [],
  12: [13],
  13: [12],
  14: [15],
  15: [14],
  16: [],
  17: [],
  18: [],
  19: [],
  20: []
};

/**
 * Check if the article (newArticleId) conflicts with any already added article.
 * Returns an object with conflict: true/false and a message.
 */
function checkConflicts(newArticleId) {
  // Get all article IDs already in the center.
  const centerArticleIds = [];
  document.querySelectorAll(".treaty-section ul li").forEach((li) => {
    const id = li.getAttribute("data-id");
    if (id) centerArticleIds.push(parseInt(id, 10));
  });

  // Get conflict list for the new article.
  const newArticleConflicts = conflictRules[newArticleId] || [];
  // Check if any article already added is in the new article's conflict list.
  for (let existingId of centerArticleIds) {
    if (newArticleConflicts.indexOf(existingId) !== -1) {
      return {
        conflict: true,
        message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
      };
    }
    // Also check reverse: if the existing article's conflict list includes the new one.
    const existingArticleConflicts = conflictRules[existingId] || [];
    if (existingArticleConflicts.indexOf(newArticleId) !== -1) {
      return {
        conflict: true,
        message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
      };
    }
  }
  return { conflict: false };
}

  /***************************************************************************
   * 6. Move article from left => center
   ***************************************************************************/
   function moveArticleToCenter(articleId, section, clickedLi) {
  // Check for conflicts before proceeding.
  const conflictCheck = checkConflicts(parseInt(articleId, 10));
  if (conflictCheck.conflict) {
    showErrorMessage(conflictCheck.message);
    return; // Do not move the article.
  }

  // (The rest of your code remains the same)
  const info = articlesInfo[articleId];
  if (!info) return;

  let sourceLi = clickedLi;
  if (!sourceLi) {
    sourceLi = document.querySelector(
      `#leftColumn ul[data-section="${section}"] li[data-id="${articleId}"]`
    );
  }
  if (!sourceLi) return;

  const ukIcon = getColoredIcon(info.Ukraine_pos);
  const ruIcon = getColoredIcon(info.Russia_pos);

  const newLi = document.createElement("li");
  newLi.setAttribute("data-id", articleId);
  newLi.setAttribute("data-section", section);

  const mainTextDiv = document.createElement("div");
  mainTextDiv.textContent = sourceLi.textContent;

  const iconDiv = document.createElement("div");
  iconDiv.style.fontSize = "0.9rem";
  iconDiv.style.marginTop = "4px";
  iconDiv.style.color = "#666";
  iconDiv.style.fontStyle = "italic";
  iconDiv.innerHTML = `UKR: ${ukIcon} &nbsp;&nbsp; RUS: ${ruIcon}`;

  newLi.appendChild(mainTextDiv);
  newLi.appendChild(iconDiv);

  const treatyUl = document.querySelector(`#treaty-${section} ul`);
  if (!treatyUl) return;

  treatyUl.appendChild(newLi);
  sourceLi.remove();

  makeLiDraggable(newLi);
  recalcRadarChart();
}

  /***************************************************************************
   * 7. Move article from center => left
   ***************************************************************************/
  function moveArticleToLeft(articleId, section, clickedLi) {
    const originalTitle = getOriginalTitle(articleId);
    if (!originalTitle) return;

    let sourceLi = clickedLi;
    if (!sourceLi) {
      sourceLi = document.querySelector(
        `#treaty-${section} ul li[data-id="${articleId}"]`
      );
    }
    if (!sourceLi) return;

    const leftUl = document.querySelector(
      `.section-block ul[data-section="${section}"]`
    );
    if (!leftUl) return;

    const newLi = document.createElement("li");
    newLi.setAttribute("data-id", articleId);
    newLi.textContent = originalTitle;
    newLi.setAttribute("draggable", "true");
    newLi.addEventListener("dragstart", handleDragStart);

    leftUl.appendChild(newLi);
    sourceLi.remove();

    makeLiDraggable(newLi);
    recalcRadarChart();
  }

  function getOriginalTitle(articleId) {
    const idNum = parseInt(articleId, 10);
    switch(idNum) {
      case 1:  return "1-Returning Ukrainian occupied portions of Kursk region";
      case 2:  return "2-Returning all territories to Ukraine (1991 borders)";
      case 3:  return "3-Maintaining Russian control as of 2025";
      case 4:  return "4-Maintaining Russian control pre-2022 (Crimea, etc.)";
      case 5:  return "5-International recognition of occupied territories";
      case 6:  return "6-Ukraine renouncing ambitions to join NATO";
      case 7:  return "7-Granting Ukraine NATO membership";
      case 8:  return "8-Legally binding bilateral defense agreements";
      case 9:  return "9-Imposing restrictions on Ukraine’s military...";
      case 10: return "10-Developing Ukrainian military-industrial complex";
      case 11: return "11-Keeping Ukrainian Army advanced & NATO-compatible";
      case 12: return "12-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability";
      case 13: return "13-Removal/easing of Western sanctions";
      case 14: return "14-Keeping Western sanctions tight";
      case 15: return "15-Releasing Russian frozen assets";
      case 16: return "16-Using Russian frozen assets to rebuild Ukraine";
      case 17: return "17-Using Ukraine’s gas transit for EU supplies";
      case 18: return "18-Allowing Western companies to use resources";
      case 19: return "19-Demanding accountability for Russian war crimes";
      case 20: return "20-Advocating safe return of deported Ukrainians";
      case 21: return "21-Having elections in Ukraine before peace settlement";
      default: return "";
    }
  }

  /***************************************************************************
   * 8. Recalc the chart => gather all articles in the center
   ***************************************************************************/
  function recalcRadarChart() {
    let selectedIds = [];
    document.querySelectorAll(".treaty-section ul li").forEach((li) => {
      const id = li.getAttribute("data-id");
      if (id) selectedIds.push(parseInt(id, 10));
    });
    if (selectedIds.length === 0) {
      radarChart.data.datasets[0].data = [0,0,0,0];
      radarChart.data.datasets[1].data = [0,0,0,0];
      radarChart.update();
      return;
    }

    let sumUkSat = 0, sumRuSat = 0, sumUsSat = 0, sumEuSat = 0;
    let sumUkNeg = 0, sumRuNeg = 0, sumUsNeg = 0, sumEuNeg = 0;
    selectedIds.forEach((id) => {
      const info = articlesInfo[id];
      if (!info) return;
      sumUkSat += info.Ukraine_sat;
      sumRuSat += info.Russia_sat;
      sumUsSat += info.USA_sat;
      sumEuSat += info.EU_sat;
      sumUkNeg += info.Ukraine_neg;
      sumRuNeg += info.Russia_neg;
      sumUsNeg += info.USA_neg;
      sumEuNeg += info.EU_neg;
    });
    const count = selectedIds.length;
    radarChart.data.datasets[0].data = [sumUkSat/count, sumRuSat/count, sumUsSat/count, sumEuSat/count];
    radarChart.data.datasets[1].data = [sumUkNeg/count, sumRuNeg/count, sumUsNeg/count, sumEuNeg/count];
    radarChart.update();
  }
// 9. PRESETS DATA
  // (Adjust IDs as desired to match your text and categories)
  const presets = {
    1: {
      territorial: [1, 4], // e.g. #1, #4
      security:    [6, 10, 11], 
      economic:    [13, 16],
      justice:     [19, 20]
    },
    2: {
      territorial: [3],
      security:    [6, 8, 12],
      economic:    [14, 17, 16],
      justice:     [19, 20]
    },
    3: {
      territorial: [3, 5],
      security:    [7, 9],
      economic:    [16, 14, 18],
      justice:     [20, 21]
    }
  };

  // 10. Helper: Clear center => move all items to the left
  function clearCenter() {
    // For each article in the center, move it to the left.
    document.querySelectorAll(".treaty-section ul li").forEach((li) => {
      const articleId = li.getAttribute("data-id");
      const parentSectionId = li.closest(".treaty-section").id;
      const section = parentSectionId.replace("treaty-", "");
      moveArticleToLeft(articleId, section, li);
    });
  }

  // 11. loadPreset => clear center, then move each item in the preset
  function loadPreset(presetNumber) {
    clearCenter();
    // For each category in the preset, move each article
    const preset = presets[presetNumber];
    if (!preset) return;

    for (let category in preset) {
      const articleIds = preset[category];
      articleIds.forEach(articleId => {
        moveArticleToCenter(articleId, category);
      });
    }
  }
  // Initial chart update
  recalcRadarChart();

/***************************************************************************
 * 10. Add the "Optimize Draft" logic here at the bottom
 ***************************************************************************/

// Helper: Return array of article IDs in the center
function getCenterArticles() {
  const ids = [];
  document.querySelectorAll(".treaty-section ul li").forEach((li) => {
    const idStr = li.getAttribute("data-id");
    if (idStr) ids.push(parseInt(idStr, 10));
  });
  return ids;
}

// Helper: Compute each stakeholder's average satisfaction for center items
function getStakeholdersData() {
  const centerIds = getCenterArticles();
  let sumUkSat=0, sumRuSat=0, sumUsSat=0, sumEuSat=0;
  const count = centerIds.length;
  centerIds.forEach((id) => {
    const info = articlesInfo[id];
    if (info) {
      sumUkSat += info.Ukraine_sat;
      sumRuSat += info.Russia_sat;
      // Make sure you have .USA_sat and .EU_sat in your articlesInfo
      sumUsSat += info.USA_sat;  
      sumEuSat += info.EU_sat;   
    }
  });
  return [
    { name: "Ukraine", sat: count ? sumUkSat / count : 0 },
    { name: "Russia",  sat: count ? sumRuSat / count : 0 },
    { name: "USA",     sat: count ? sumUsSat / count : 0 },
    { name: "Europe",  sat: count ? sumEuSat / count : 0 }
  ];
}

// Identify which stakeholder is below threshold or has the absolute lowest
function findLowestStakeholder() {
  const data = getStakeholdersData();
  if (!data.length) return {};

  // 1) Check if Ukraine or Russia is below threshold
  let below = data.filter(d => 
    (d.name === "Ukraine" || d.name === "Russia") && d.sat < thresholdValue
  );
  if (below.length) {
    below.sort((a,b) => a.sat - b.sat);
    return { lowestStakeholder: below[0].name };
  }
  // 2) Then check if US or EU is below threshold
  below = data.filter(d => 
    (d.name === "USA" || d.name === "Europe") && d.sat < thresholdValue
  );
  if (below.length) {
    below.sort((a,b) => a.sat - b.sat);
    return { lowestStakeholder: below[0].name };
  }
  // 3) If none are below threshold, pick the absolute lowest with priority UA/RU
  data.sort((a,b) => a.sat - b.sat);
  // pick the first found that's UA/RU, else pick the absolute first
  let candidate = data.find(d => (d.name === "Ukraine" || d.name === "Russia")) 
                || data[0];
  return { lowestStakeholder: candidate.name };
}

// Among the other 3 stakeholders, pick one with highest satisfaction
function findHighestSatisfactionStakeholder(excludeName) {
  const data = getStakeholdersData().filter(d => d.name !== excludeName);
  if (!data.length) return null;
  data.sort((a,b) => b.sat - a.sat);

  // "less important first (US, EU)"
  const americansOrEuropeans = data.filter(d => d.name === "USA" || d.name === "Europe");
  if (americansOrEuropeans.length) {
    // pick the highest from americansOrEuropeans
    americansOrEuropeans.sort((a,b) => b.sat - a.sat);
    return americansOrEuropeans[0].name;
  }
  // Otherwise pick the top from the entire array
  return data[0].name;
}

// This function reorders & highlights items from the "donor" stakeholder
// to the top of their category in the center
function reorderAndHighlightNegotiationItems(donorName) {
  const centerLis = document.querySelectorAll(".treaty-section ul li");
  const itemArray = [];

  // 1) Store old bounding rect for each item
  const oldRects = new Map();
  centerLis.forEach(li => {
    const rect = li.getBoundingClientRect();
    oldRects.set(li, rect);
  });

  centerLis.forEach(li => {
    const idStr = li.getAttribute("data-id");
    if (!idStr) return;
    const id = parseInt(idStr, 10);
    const catSection = li.closest(".treaty-section").id.replace("treaty-", "");
    if (!articlesInfo[id]) return;

    // Determine the donor's 'pos' for this article
    let donorPos = 0;
    switch(donorName) {
      case "Ukraine": donorPos = articlesInfo[id].Ukraine_pos; break;
      case "Russia":  donorPos = articlesInfo[id].Russia_pos;  break;
      case "USA":     donorPos = 2; break; 
      case "Europe":  donorPos = 2; break;
    }
    itemArray.push({
      liElement: li,
      articleId: id,
      position: donorPos,
      catSection
    });
  });

  // 2) Sort them so that 'position=2' items come first, then 0, then 1
  //    Because you want the negotiable items at the top
  //    We'll define numeric priority: pos=2 => prio=1, pos=0 => prio=2, pos=1 => prio=3
  function priority(pos) {
    return (pos === 2) ? 1 : (pos === 0 ? 2 : 3);
  }
  itemArray.sort((a,b) => priority(a.position) - priority(b.position));

  // 3) Re-insert them in sorted order
  //    We'll do it per category, so we group by catSection:
  const sectionsMap = {};
  itemArray.forEach(item => {
    if (!sectionsMap[item.catSection]) {
      sectionsMap[item.catSection] = [];
    }
    sectionsMap[item.catSection].push(item);
  });

  for (let cat in sectionsMap) {
    const sortedItems = sectionsMap[cat];
    // We'll re-insert them from first to last => top item is first
    const parentUl = document.querySelector(`#treaty-${cat} ul`);
    if (!parentUl) continue;

    // Insert them in ascending order
    // The item at index 0 becomes the top of the list
    sortedItems.forEach(obj => {
      parentUl.insertBefore(obj.liElement, parentUl.firstChild);
    });
  }

  // 4) Highlight only if donorName is UA or RU and pos=2
  itemArray.forEach(item => {
    if ((donorName === 'Ukraine' || donorName === 'Russia') && item.position === 2) {
      item.liElement.classList.add("highlight-negotiation");
    } else {
      item.liElement.classList.remove("highlight-negotiation");
    }
  });

  // 5) FLIP animation: measure new bounding rect, animate from old->new
  itemArray.forEach(item => {
    const li = item.liElement;
    const newRect = li.getBoundingClientRect();
    const oldRect = oldRects.get(li);
    // compute how far it moved
    const deltaX = oldRect.left - newRect.left;
    const deltaY = oldRect.top - newRect.top;

    // apply transform to start it from old position
    li.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    li.style.transition = 'none';

    // then in next frame, remove the transform so it transitions to new position
    requestAnimationFrame(() => {
      li.style.transition = 'transform 0.3s ease-out'; 
      li.style.transform = '';
    });
  });
}


// The main function the "Optimize Draft" button calls
function optimizeDraft() {
  // 1) find stakeholder with lowest satisfaction
  const {lowestStakeholder} = findLowestStakeholder();
  const centerIds = getCenterArticles();
  if (!lowestStakeholder || !centerIds.length) {
    showErrorMessage("No articles or no stakeholder found to optimize.");
    return;
  }

  // 2) find one stakeholder with highest satisfaction who can yield
  const donorStakeholder = findHighestSatisfactionStakeholder(lowestStakeholder);
  if (!donorStakeholder) {
    showErrorMessage("No stakeholder found with high satisfaction.");
    return;
  }

  // 3) reorder & highlight items from donor
  reorderAndHighlightNegotiationItems(donorStakeholder);

  // Recalc or show a message
  recalcRadarChart();
  showErrorMessage(`Reordered items from ${donorStakeholder} to help ${lowestStakeholder}.`);
}
</script>

</body>
</html>



