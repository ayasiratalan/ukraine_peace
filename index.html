<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern Peace Agreement Dashboard</title>
  <!-- Import Google Fonts: Roboto -->
  <!-- <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"> -->
    <style>
    @font-face {
      font-family: 'Publico';
      src: url('fonts/Publico-Regular.woff2') format('woff2'),
           url('fonts/Publico-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Publico';
      src: url('fonts/Publico-Bold.woff2') format('woff2'),
           url('fonts/Publico-Bold.woff') format('woff');
      font-weight: 700;
      font-style: normal;
    }
  </style>
  
  <style>
    /* ---------------------------
       Modern Global Styles

   
  

    /* Removed negotiability-frame styling */

    /* ---------------------------
       Container & Card Styles
       --------------------------- */
    .container {
      max-width: 1300px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-radius: 8px;
      display: flex;
      flex-direction: row; /* default: side by side in large screens */
      gap: 1rem;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Publico', serif;
      font-size: 1rem;
      background-color: #f7f8fa; /* very light gray */
      color: #333;
      line-height: 1.6;
    }
    /* ---------------------------
       Column Layout
       --------------------------- */
    #leftColumn, #centerColumn, #rightColumn {
      background-color: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.05);
    }
    #leftColumn, #rightColumn {
      flex: 1;
      min-width: 330px;
    }
    #centerColumn {
      flex: 2;
      box-shadow: 0 0 22px rgba(0,0,0,0.25); /* Even more obvious shadow */
    }
    /* Optional borders between columns */
    #leftColumn { border-right: 1px solid #e0e0e0; }
    #rightColumn { border-left: 1px solid #e0e0e0; }

    /* ---------------------------
       Headings & Text
       --------------------------- */
    h1, h2, h3 {
      font-weight: 500;
      color: #222;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    /* ---------------------------
       Subheader Enhancements
       --------------------------- */
    .section-block h2 {
      background-color: #e8efff;
      border-left: 4px solid #007bff;
      padding: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .treaty-section h3 {
      background-color: #e8efff;
      border-left: 4px solid #007bff;
      padding: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* ---------------------------
       Instructions Frame
       --------------------------- */
    #instructions {
      max-width: 1300px;
      margin: 1rem auto;
      padding: 1.5rem;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: justify;
    }
    #instructions p {
      margin-bottom: 1rem;
    }
    .step-container {
  display: flex;
  gap: 1rem;
  justify-content: space-around; /* or 'space-between' */
  margin-bottom: 1rem;
}

.step-box {
  flex: 1;
  border: 2px solid #007bff;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.step-header {
  display: flex;
  align-items: center;
  margin-bottom: 0.75rem;
}

.step-number {
  width: 30px;
  height: 30px;
  background-color: #007bff;
  color: #fff;
  font-weight: bold;
  text-align: center;
  line-height: 30px;
  border-radius: 50%;
  margin-right: 0.5rem;
}

    /* ---------------------------
       Modern Buttons
       --------------------------- */
    button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-family: 'Publico', serif;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #2379d4;
      color: #fff;
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
    }
    button:hover {
      background-color: #0069d9;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button:active {
      background-color: #005cbf;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    /* New style for Start Again button */
    .start-again-btn {
      background-color: #d9534f; /* different red color */
    }
    .start-again-btn:hover {
      background-color: #c9302c;
    }

    /* ---------------------------
       List & Item Styling
       --------------------------- */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      margin: 0.5rem 0;
      padding: 0.75rem;
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      user-select: none;
    }
    li:hover {
      background-color: #f1f1f1;
    }

    /* ---------------------------
       Chart Container & Legend
       --------------------------- */
    #radarContainer {
      width: 100%;
      max-width: 580px;
      height: 400px;
      margin: 0 auto;
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1rem;
      box-sizing: border-box;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    #chartLegend {
      text-align: left;
      margin-top: 1rem;
    }
    #chartLegend ul li {
      margin-bottom: 0.5rem;
    }

    /* ---------------------------
       Highlight Class
       --------------------------- */
    .highlight-negotiation {
      background-color: #ffdea5 !important; /* light yellow */
      border: 2px solid #ffcc00 !important; /* orange border */
    }

    /* Center headings styles for instructions */
    #instructions h1, #instructions h2 {
      text-align: center;
    }

    /* ------------------------------------
       RESPONSIVE ADAPTATION FOR SMALL SCREENS
       ------------------------------------ */
    @media (max-width: 900px) {
      .container {
        flex-direction: column; /* Stack columns vertically */
      }

      /* Remove or reduce column-based styling so they become full-width blocks */
      #leftColumn,
      #centerColumn,
      #rightColumn {
        min-width: auto;
        width: 100%;
        margin-bottom: 1rem;
        border: none; /* remove the left/right borders for a cleaner stacked view */
        box-shadow: none; /* optional: remove or reduce shadow on mobile */
      }

      #centerColumn {
        box-shadow: 0 0 22px rgba(0,0,0,0.25); /* you can keep a more prominent shadow if desired */
      }

      /* Adjust font sizes a bit on smaller screens (optional) */
      h1 {
        font-size: 1.3rem;
      }
      h2 {
        font-size: 1rem;
      }
      h3 {
        font-size: 1rem;
      }

      button {
        font-size: 0.9rem;
        padding: 0.65rem 1rem;
      }

      li {
        margin: 0.4rem 0;
        padding: 0.6rem;
      }
    }
  </style>
</head>
<body>


  <div id="instructions">
    <h1>Ukraine-Russia Peace Talks Simulator</h1>
  
    <!-- Three-Step Instruction Boxes -->
    <div class="step-container">
      
      <!-- Step 1 -->
      <div class="step-box">
        <div class="step-header">
          <div class="step-number">1</div>
          <h2>Building the Draft Agreement</h2>
        </div>
        <p>
          The panel “Available Negotiation Items” contains 20 negotiation items divided into 4 categories.
          To start drafting a peace agreement, select or drag items into the Draft Agreement Panel in the center.
        </p>
        <p>
          As items are added to the Draft Agreement Panel, stakeholders’ positions are displayed below each
          item using indicators: green checkmarks (support), red crosses (opposition), and yellow question marks
          (willingness to negotiate).
        </p>
      </div>
  
      <!-- Step 2 -->
      <div class="step-box">
        <div class="step-header">
          <div class="step-number">2</div>
          <h2>Analyzing the Agreement</h2>
        </div>
        <p>
          The Analysis Panel visualizes and tracks satisfaction levels (green), negotiability scores (blue), 
          and minimum acceptable thresholds (red line) for Ukraine, Russia, the USA, and the EU.
        </p>
        <p>
          Aim to maintain all stakeholder satisfaction above the red threshold to avoid failed negotiations.
          Identify promising negotiation paths by focusing on areas where stakeholders show both acceptable
          satisfaction and high negotiability.
        </p>
      </div>
  
      <!-- Step 3 -->
      <div class="step-box">
        <div class="step-header">
          <div class="step-number">3</div>
          <h2>Optimizing the Agreement</h2>
        </div>
        <p>
          If stakeholder satisfaction drops below the minimum threshold or improvement is needed, use
          the optimization feature. Click the “Optimize Draft” button below the radar chart.
          The tool will highlight items in yellow that offer the best potential for enhancing agreement stability.
        </p>
        <p>
          Experiment with substituting items in the Draft Agreement Panel, prioritizing combinations that 
          maintain satisfaction above critical thresholds while maximizing negotiation flexibility.
        </p>
      </div>
    </div>
  <div style="text-align: center;">
    <button onclick="loadPreset(1)">Balanced Settlement</button>
    <button onclick="loadPreset(2)">Pro-Russia Settlement</button>
    <button onclick="loadPreset(3)">Pro-Ukraine Settlement</button>
    <br>
    <!-- Start Again button with a different style -->
    <button class="start-again-btn" onclick="startAgain()">Start Again</button>
  </div>
  <div id="contactInfo">
    For questions: <a href="https://www.csis.org/people/kateryna-bondar" target="_blank">Kate Bondar</a> &amp; <a href="https://www.csis.org/people/yasir-atalan" target="_blank">Yasir Atalan</a>
  </div>
</div>


  <div class="container">
    <!-- LEFT COLUMN: Available Articles -->
    <div id="leftColumn">
      <h1 style="text-align: center;">Available Negotiation Articles</h1>

      <!-- Territory and Sovereignty -->
      <div class="section-block">
        <h2>Territory and Sovereignty</h2>
        <ul data-section="territorial">
          <li data-id="1" draggable="true">1-Returning Ukrainian occupied portions of Kursk region</li>
          <li data-id="2" draggable="true">2-Maintaining Russian control over all occupied territories as of 2025</li>
          <li data-id="3" draggable="true">3-Maintaining Russian control over Zaporizhzhia and Kherson and territories occupied before 2022 (Crimea and parts of the DNR/LNR)</li>
          <li data-id="4" draggable="true">4-Ensuring international recognition of occupied territories as Russian territory</li>
        </ul>
      </div>

      <!-- Security Arrangements -->
      <div class="section-block">
        <h2>Security Arrangements</h2>
        <ul data-section="security">
          <li data-id="5" draggable="true">5-Ukraine renouncing its ambitions to join NATO</li>
          <li data-id="6" draggable="true">6-Granting Ukraine NATO membership</li>
          <li data-id="7" draggable="true">7-Legally binding bilateral defense agreements between Western nations and Ukraine</li>
          <li data-id="8" draggable="true">8-Imposing restrictions on Ukraine's military capabilities, including limits on troop numbers,  missile systems, and Western-supplied weapons</li>
          <li data-id="9" draggable="true">9-Developing Ukrainian military-industrial complex and defense industry</li>
          <li data-id="10" draggable="true">10-Keeping Ukrainian Army self-sufficient and technologically advanced, fully interoperable with NATO</li>
          <li data-id="11" draggable="true">11-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability</li>
        </ul>
      </div>

      <!-- Economic Conditions -->
      <div class="section-block">
        <h2>Economic Conditions</h2>
        <ul data-section="economic">
          <li data-id="12" draggable="true">12-Removal or easing of Western sanctions that have constrained Russia's economy</li>
          <li data-id="13" draggable="true">13-Keeping Western sanctions tight not to allow Russia rebuild its economy and improve miltech</li>
          <li data-id="14" draggable="true">14-Releasing Russian frozen assets, returning them to Russia</li>
          <li data-id="15" draggable="true">15-Using Russian frozen assets to rebuild Ukriane</li>
          <li data-id="16" draggable="true">16-Using Ukraine's gas transit infrastructure for European energy supplies from Russia</li>
          <li data-id="17" draggable="true">17-Allowing Western companies to use Ukrainain resources as raw materials</li>
        </ul>
      </div>

      <!-- Justice and Accountability -->
      <div class="section-block">
        <h2>Justice and Accountability</h2>
        <ul data-section="justice">
          <li data-id="18" draggable="true">18-Demanding accountability for Russian war crimes, including trials for those responsible for atrocities and crimes against humanity</li>
          <li data-id="19" draggable="true">19- Advocating for the safe return of forcibly deported Ukrainians, including  kidnapped children</li>
          <li data-id="20" draggable="true">20-Having elections in Ukraine before peace/ceasefire settlement</li>
        </ul>
      </div>
    </div>

    <!-- CENTER COLUMN: Official Peace Treaty -->
    <div id="centerColumn" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'center')">
      <div class="official-doc">
        <!-- Error Message Container -->
        <div id="errorMessage" style="display:none; margin-bottom:1rem; padding:0.75rem; background-color:#ffe6e6; border:1px solid #ff8888; text-align:center;"></div>
        <h1 style="text-align: center;">Peace Agreement Draft</h1>

        <!-- Treaty Sections -->
        <div class="treaty-section" id="treaty-territorial">
          <h3>Territory and Sovereignty</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-security">
          <h3>Security Arrangement</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-economic">
          <h3>Economic Conditions</h3>
          <ul></ul>
        </div>
        <div class="treaty-section" id="treaty-justice">
          <h3>Justice and Accountability</h3>
          <ul></ul>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Radar Chart -->
    <div id="rightColumn"
         ondragover="allowDrop(event)"
         ondrop="handleDrop(event, 'right')">
         <h1 style="text-align: center;">Negotiation Analysis</h1>
      <div id="radarContainer">
        <canvas id="radarChart"></canvas>
        <!-- Optimize Draft Button -->
        <div style="text-align: center; width: 100%; margin-top: 1rem;">
          <button id="optimizeButton" onclick="optimizeDraft()">Optimize Draft</button>
        </div>
        <!-- Chart Legend -->
        <div id="chartLegend">
          <p><strong>Legend:</strong></p>
          <ul>
            <li><span style="color:rgb(10, 163, 97)">Satisfaction</span>: Green area representing overall satisfaction.</li>
            <li><span style="color:rgba(54,162,235,1)">Negotiability</span>: Blue area representing negotiability scores.</li>
            <li><span style="color:red; border-bottom: 1px dashed black;">Minimum Acceptable Threshold</span>: Red dashed line indicating the minimum acceptable level.</li>
          </ul>
        </div>
      </div>
    </div>
  </div><!-- end .container -->


  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /***************************************************************************
     * 1. Data for each article:
     *    - <actor>_sat, <actor>_neg
     *    - Ukraine_pos, Russia_pos (used for icons: 1 => ✔, 0 => ✖, 2 => ?)
     ***************************************************************************/
    const articlesInfo = {
      1: { Ukraine_sat: 7,  Ukraine_neg: 9,  Russia_sat: 10, Russia_neg: 2,  USA_sat: 8,  USA_neg: 8,  EU_sat: 8,  EU_neg: 8,  Ukraine_pos: 2, Russia_pos: 1 },
      2: { Ukraine_sat: 3,  Ukraine_neg: 5,  Russia_sat: 10, Russia_neg: 6,  USA_sat: 6,  USA_neg: 7,  EU_sat: 4,  EU_neg: 7,  Ukraine_pos: 0, Russia_pos: 1 },
      3: { Ukraine_sat: 5,  Ukraine_neg: 7,  Russia_sat: 9,  Russia_neg: 5,  USA_sat: 6,  USA_neg: 8,  EU_sat: 6,  EU_neg: 8,  Ukraine_pos: 0, Russia_pos: 1 },
      4: { Ukraine_sat: 2,  Ukraine_neg: 3,  Russia_sat: 10, Russia_neg: 7,  USA_sat: 5,  USA_neg: 7,  EU_sat: 3,  EU_neg: 5,  Ukraine_pos: 0, Russia_pos: 1 },
      5: { Ukraine_sat: 3,  Ukraine_neg: 6,  Russia_sat: 10, Russia_neg: 4,  USA_sat: 7,  USA_neg: 7,  EU_sat: 5,  EU_neg: 7,  Ukraine_pos: 2, Russia_pos: 1 },
      6: { Ukraine_sat: 10, Ukraine_neg: 7,  Russia_sat: 2,  Russia_neg: 2,  USA_sat: 5,  USA_neg: 7,  EU_sat: 7,  EU_neg: 8,  Ukraine_pos: 1, Russia_pos: 0 },
      7: { Ukraine_sat: 9,  Ukraine_neg: 6,  Russia_sat: 3,  Russia_neg: 5,  USA_sat: 7,  USA_neg: 7,  EU_sat: 8,  EU_neg: 7,  Ukraine_pos: 1, Russia_pos: 0 },
      8: { Ukraine_sat: 2,  Ukraine_neg: 3,  Russia_sat: 10, Russia_neg: 6,  USA_sat: 5,  USA_neg: 7,  EU_sat: 4,  EU_neg: 6,  Ukraine_pos: 0, Russia_pos: 1 },
      9: { Ukraine_sat: 10, Ukraine_neg: 5,  Russia_sat: 4,  Russia_neg: 6,  USA_sat: 7,  USA_neg: 7,  EU_sat: 9,  EU_neg: 6,  Ukraine_pos: 1, Russia_pos: 0 },
      10:{ Ukraine_sat: 10, Ukraine_neg: 4,  Russia_sat: 4,  Russia_neg: 5,  USA_sat: 8,  USA_neg: 7,  EU_sat: 9,  EU_neg: 6,  Ukraine_pos: 1, Russia_pos: 0 },
      11:{ Ukraine_sat: 9,  Ukraine_neg: 6,  Russia_sat: 5,  Russia_neg: 6,  USA_sat: 7,  USA_neg: 7,  EU_sat: 8,  EU_neg: 7,  Ukraine_pos: 1, Russia_pos: 0 },
      12:{ Ukraine_sat: 4,  Ukraine_neg: 6,  Russia_sat: 10, Russia_neg: 5,  USA_sat: 7,  USA_neg: 8,  EU_sat: 6,  EU_neg: 7,  Ukraine_pos: 0, Russia_pos: 1 },
      13:{ Ukraine_sat: 10, Ukraine_neg: 7,  Russia_sat: 3,  Russia_neg: 5,  USA_sat: 6,  USA_neg: 8,  EU_sat: 7,  EU_neg: 7,  Ukraine_pos: 1, Russia_pos: 0 },
      14:{ Ukraine_sat: 4,  Ukraine_neg: 6,  Russia_sat: 9,  Russia_neg: 5,  USA_sat: 6,  USA_neg: 8,  EU_sat: 5,  EU_neg: 6,  Ukraine_pos: 0, Russia_pos: 1 },
      15:{ Ukraine_sat: 10, Ukraine_neg: 7,  Russia_sat: 3,  Russia_neg: 4,  USA_sat: 7,  USA_neg: 7,  EU_sat: 7,  EU_neg: 7,  Ukraine_pos: 1, Russia_pos: 0 },
      16:{ Ukraine_sat: 6,  Ukraine_neg: 7,  Russia_sat: 8,  Russia_neg: 8,  USA_sat: 6,  USA_neg: 8,  EU_sat: 8,  EU_neg: 7,  Ukraine_pos: 2, Russia_pos: 1 },
      17:{ Ukraine_sat: 6,  Ukraine_neg: 9,  Russia_sat: 6,  Russia_neg: 8,  USA_sat: 8,  USA_neg: 8,  EU_sat: 8,  EU_neg: 8,  Ukraine_pos: 1, Russia_pos: 2 },
      18:{ Ukraine_sat: 10, Ukraine_neg: 6,  Russia_sat: 2,  Russia_neg: 3,  USA_sat: 6,  USA_neg: 8,  EU_sat: 8,  EU_neg: 7,  Ukraine_pos: 1, Russia_pos: 0 },
      19:{ Ukraine_sat: 10, Ukraine_neg: 3,  Russia_sat: 5,  Russia_neg: 7,  USA_sat: 8,  USA_neg: 8,  EU_sat: 9,  EU_neg: 6,  Ukraine_pos: 1, Russia_pos: 2 },
      20:{ Ukraine_sat: 4,  Ukraine_neg: 5,  Russia_sat: 8,  Russia_neg: 7,  USA_sat: 7,  USA_neg: 7,  EU_sat: 5,  EU_neg: 6,  Ukraine_pos: 0, Russia_pos: 1 },
    };

    /***************************************************************************
     * 2. Icons for Ukraine/Russia positions: 1 => ✔, 0 => ✖, 2 => ?
     ***************************************************************************/
    function getColoredIcon(pos) {
      if (pos === 1) {
        return '<span style="color: #66cc66;">\u2713</span>'; // ✔
      } else if (pos === 2) {
        return '<span style="color: #cccc00;">?</span>';      // ?
      } else if (pos === 0) {
        return '<span style="color: #ff6666;">\u00d7</span>'; // ✖
      }
      return '';
    }

    function showErrorMessage(message) {
      const errorDiv = document.getElementById("errorMessage");
      if (errorDiv) {
        errorDiv.innerText = message;
        errorDiv.style.display = "block";
        // Hide the message after 3 seconds (or adjust as needed)
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 3000);
      }
    }

    /***************************************************************************
     * 3. Radar Chart initialization (Chart.js)
     ***************************************************************************/
    const thresholdPercentage = 0.5; // 50%
    const maxSatisfaction = 10;     
    const thresholdValue = thresholdPercentage * maxSatisfaction; // e.g., 5

    const radarData = {
      labels: ["Ukraine", "Russia", "USA", "Europe"],
      datasets: [
        {
          label: "Satisfaction",
          data: [0, 0, 0, 0],
          backgroundColor: "rgba(10, 163, 97,0.2)",
          borderColor: "rgba(10, 163, 97,1)",
          pointBackgroundColor: "rgba(10, 163, 97,1)",
          fill: true,
          borderWidth: 0.4,
          pointRadius: 0.7
        },
        {
          label: "Negotiability",
          data: [0, 0, 0, 0],
          backgroundColor: "rgba(54,162,235,0.2)",
          borderColor: "rgba(54,162,235,1)",
          pointBackgroundColor: "rgba(54,162,235,1)",
          fill: true,
          borderWidth: 0.4,
          pointRadius: 0.7
        },
        {
          label: "Minimum Acceptable Threshold",
          data: [5, 6.5, 3, 4], // Example thresholds for UA, RU, US, EU
          borderColor: "red",
          pointBackgroundColor: "red",
          backgroundColor: "rgba(255,0,0,0)",
          fill: false,
          borderDash: [5, 5],
          borderWidth: 0.7,
          pointRadius: 0.5
        }
      ]
    };

    const radarChart = new Chart(document.getElementById('radarChart').getContext('2d'), {
      type: 'radar',
      data: radarData,
      options: {
        scales: {
          r: {
            min: 0,
            max: 10,
            ticks: {
              beginAtZero: true,
              stepSize: 1,
              font: {
                size: 8, // smaller font size for the tick labels
                family: 'Publico'
              },
              color: '#000000',
              callback: function(value) {
                // Only display labels for tick values 1, 4, 7, and 10
                return [1, 4, 7, 10].includes(value) ? value : '';
              }
            },
            pointLabels: {
              font: {
                size: 12,
                family: 'Publico',
                style: 'bold'
              },
              color: '#000000'
            }
          }
        }
      }
    });

    /***************************************************************************
     * 4. Drag & Drop handling
     ***************************************************************************/
    function allowDrop(event) {
      event.preventDefault();
    }

    function handleDragStart(event) {
      const li = event.target;
      const articleId = li.getAttribute("data-id");
      let origin, section;
      
      if (li.closest("#centerColumn")) {
        origin = "center";
        section = li.getAttribute("data-section");
      } else {
        origin = "left";
        const parentUl = li.closest("ul[data-section]");
        if (parentUl) {
          section = parentUl.getAttribute("data-section");
        }
      }
      
      const dragData = JSON.stringify({ articleId, origin, section });
      event.dataTransfer.setData("text/plain", dragData);
    }

    function handleDrop(event, dropZone) {
      event.preventDefault();
      const data = event.dataTransfer.getData("text/plain");
      if (!data) return;
      const { articleId, origin, section } = JSON.parse(data);

      if (dropZone === 'center') {
        if (origin === 'left') {
          moveArticleToCenter(articleId, section);
        }
      } else if (dropZone === 'left') {
        if (origin === 'center') {
          moveArticleToLeft(articleId, section);
        }
      }
      // 'right' dropZone not used
    }

    const leftColumn = document.getElementById("leftColumn");
    leftColumn.ondragover = allowDrop;
    leftColumn.ondrop = (event) => {
      handleDrop(event, 'left');
    };

    document.querySelectorAll("#leftColumn li").forEach((li) => {
      li.addEventListener("dragstart", handleDragStart);
    });

    function makeLiDraggable(li) {
      li.setAttribute("draggable", "true");
      li.addEventListener("dragstart", handleDragStart);
    }

    /***************************************************************************
     * 5. Click-based move logic
     ***************************************************************************/
    leftColumn.addEventListener("click", (event) => {
      const li = event.target;
      if (li && li.tagName === "LI") {
        const articleId = li.getAttribute("data-id");
        const parentUl = li.closest("ul");
        const section = parentUl.getAttribute("data-section");
        moveArticleToCenter(articleId, section, li);
      }
    });

    const centerColumn = document.getElementById("centerColumn");
    centerColumn.addEventListener("click", (event) => {
      const li = event.target;
      if (li && li.tagName === "LI") {
        const articleId = li.getAttribute("data-id");
        const parentSectionId = li.closest(".treaty-section")?.id;
        if (!parentSectionId) return;
        const section = parentSectionId.replace("treaty-", "");
        moveArticleToLeft(articleId, section, li);
      }
    });

    /***************************************************************************
     * 6. Conflict rules (still used if needed)
     ***************************************************************************/
    const conflictRules = {
      1:  [],
      2:  [3],
      3:  [2],
      4:  [],
      5:  [6],
      6:  [5],
      7:  [],
      8:  [10],
      9:  [],
      10: [8],
      11: [],
      12: [13],
      13: [12],
      14: [15],
      15: [14],
      16: [],
      17: [],
      18: [],
      19: [],
      20: []
    };

    function checkConflicts(newArticleId) {
      const centerArticleIds = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const id = li.getAttribute("data-id");
        if (id) centerArticleIds.push(parseInt(id, 10));
      });

      const newArticleConflicts = conflictRules[newArticleId] || [];
      for (let existingId of centerArticleIds) {
        if (newArticleConflicts.indexOf(existingId) !== -1) {
          return {
            conflict: true,
            message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
          };
        }
        const existingArticleConflicts = conflictRules[existingId] || [];
        if (existingArticleConflicts.indexOf(newArticleId) !== -1) {
          return {
            conflict: true,
            message: `Article ${newArticleId} conflicts with article ${existingId}. They cannot be in the draft together.`
          };
        }
      }
      return { conflict: false };
    }

    /***************************************************************************
     * 7. Move article from left => center
     ***************************************************************************/
    function moveArticleToCenter(articleId, section, clickedLi) {
      // Check for conflicts first
      const conflictCheck = checkConflicts(parseInt(articleId, 10));
      if (conflictCheck.conflict) {
        showErrorMessage(conflictCheck.message);
        return;
      }

      const info = articlesInfo[articleId];
      if (!info) return;

      let sourceLi = clickedLi;
      if (!sourceLi) {
        sourceLi = document.querySelector(
          `#leftColumn ul[data-section="${section}"] li[data-id="${articleId}"]`
        );
      }
      if (!sourceLi) return;

      const ukIcon = getColoredIcon(info.Ukraine_pos);
      const ruIcon = getColoredIcon(info.Russia_pos);

      const newLi = document.createElement("li");
      newLi.setAttribute("data-id", articleId);
      newLi.setAttribute("data-section", section);

      const mainTextDiv = document.createElement("div");
      mainTextDiv.textContent = sourceLi.textContent;

      const iconDiv = document.createElement("div");
      iconDiv.style.fontSize = "0.9rem";
      iconDiv.style.marginTop = "4px";
      iconDiv.style.color = "#666";
      iconDiv.style.fontStyle = "italic";
      iconDiv.innerHTML = `UKR: ${ukIcon} &nbsp;&nbsp; RUS: ${ruIcon}`;

      newLi.appendChild(mainTextDiv);
      newLi.appendChild(iconDiv);

      const treatyUl = document.querySelector(`#treaty-${section} ul`);
      if (!treatyUl) return;

      treatyUl.appendChild(newLi);
      sourceLi.remove();

      makeLiDraggable(newLi);
      recalcRadarChart();
    }

    /***************************************************************************
     * 8. Move article from center => left
     ***************************************************************************/
    function moveArticleToLeft(articleId, section, clickedLi) {
      const originalTitle = getOriginalTitle(articleId);
      if (!originalTitle) return;

      let sourceLi = clickedLi;
      if (!sourceLi) {
        sourceLi = document.querySelector(
          `#treaty-${section} ul li[data-id="${articleId}"]`
        );
      }
      if (!sourceLi) return;

      const leftUl = document.querySelector(
        `.section-block ul[data-section="${section}"]`
      );
      if (!leftUl) return;

      const newLi = document.createElement("li");
      newLi.setAttribute("data-id", articleId);
      newLi.textContent = originalTitle;
      newLi.setAttribute("draggable", "true");
      newLi.addEventListener("dragstart", handleDragStart);

      leftUl.appendChild(newLi);
      sourceLi.remove();

      makeLiDraggable(newLi);
      recalcRadarChart();
    }

    function getOriginalTitle(articleId) {
      const idNum = parseInt(articleId, 10);
      switch(idNum) {
        case 1:  return "1-Returning Ukrainian occupied portions of Kursk region";
        case 2:  return "2-Maintaining Russian control over all occupied territories as of 2025";
        case 3:  return "3-Maintaining Russian control over Zaporizhzhia and Kherson and territories occupied before 2022 (Crimea and parts of the DNR/LNR)";
        case 4:  return "4-Ensuring international recognition of occupied territories as Russian territory";
        case 5:  return "5-Ukraine renouncing its ambitions to join NATO";
        case 6:  return "6-Granting Ukraine NATO membership";
        case 7:  return "7-Legally binding bilateral defense agreements between Western nations and Ukraine";
        case 8:  return "8-Imposing restrictions on Ukraine's military capabilities, including limits on troop numbers,  missile systems, and Western-supplied weapons";
        case 9:  return "9-Developing Ukrainian military-industrial complex and defense industry";
        case 10: return "10-Keeping Ukrainian Army self-sufficient and technologically advanced, fully interoperable with NATO";
        case 11: return "11-Considering peacekeeping forces, demilitarized zones to maintain post-conflict stability";
        case 12: return "12-Removal or easing of Western sanctions that have constrained Russia's economy";
        case 13: return "13-Keeping Western sanctions tight not to allow Russia rebuild its economy and improve miltech";
        case 14: return "14-Releasing Russian frozen assets, returning them to Russia";
        case 15: return "15-Using Russian frozen assets to rebuild Ukriane";
        case 16: return "16-Using Ukraine's gas transit infrastructure for European energy supplies from Russia";
        case 17: return "17-Allowing Western companies to use Ukrainain resources as raw materials";
        case 18: return "18-Demanding accountability for Russian war crimes, including trials for those responsible for atrocities and crimes against humanity";
        case 19: return "19- Advocating for the safe return of forcibly deported Ukrainians, including  kidnapped children";
        case 20: return "20-Having elections in Ukraine before peace/ceasefire settlement";
        default: return "";
      }
    }

    /***************************************************************************
     * 9. Recalc the chart => gather all articles in the center
     ***************************************************************************/
    function recalcRadarChart() {
      let selectedIds = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const id = li.getAttribute("data-id");
        if (id) selectedIds.push(parseInt(id, 10));
      });
      if (selectedIds.length === 0) {
        radarChart.data.datasets[0].data = [0,0,0,0];
        radarChart.data.datasets[1].data = [0,0,0,0];
        radarChart.update();
        return;
      }

      let sumUkSat = 0, sumRuSat = 0, sumUsSat = 0, sumEuSat = 0;
      let sumUkNeg = 0, sumRuNeg = 0, sumUsNeg = 0, sumEuNeg = 0;
      selectedIds.forEach((id) => {
        const info = articlesInfo[id];
        if (!info) return;
        sumUkSat += info.Ukraine_sat;
        sumRuSat += info.Russia_sat;
        sumUsSat += info.USA_sat;
        sumEuSat += info.EU_sat;
        sumUkNeg += info.Ukraine_neg;
        sumRuNeg += info.Russia_neg;
        sumUsNeg += info.USA_neg;
        sumEuNeg += info.EU_neg;
      });
      const count = selectedIds.length;
      radarChart.data.datasets[0].data = [
        sumUkSat/count,
        sumRuSat/count,
        sumUsSat/count,
        sumEuSat/count
      ];
      radarChart.data.datasets[1].data = [
        sumUkNeg/count,
        sumRuNeg/count,
        sumUsNeg/count,
        sumEuNeg/count
      ];
      radarChart.update();
    }



    /***************************************************************************
     * 10. Presets for quick loading
     ***************************************************************************/
    const presets = {
      1: {
        territorial: [1, 2],
        security:    [5, 7, 11],
        economic:    [12, 15,17],
        justice:     [19]
      },
      2: {
        territorial: [1,2],
        security:    [5, 8,],
        economic:    [14, 16, 17],
        justice:     [19, 20]
      },
      3: {
        territorial: [3, 5],
        security:    [7, 9,10,11],
        economic:    [12, 15, 16],
        justice:     [20]
      }
    };

    function clearCenter() {
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const articleId = li.getAttribute("data-id");
        const parentSectionId = li.closest(".treaty-section").id;
        const section = parentSectionId.replace("treaty-", "");
        moveArticleToLeft(articleId, section, li);
      });
    }
    function loadPreset(presetNumber) {
      clearCenter();
      const preset = presets[presetNumber];
      if (!preset) return;
      for (let category in preset) {
        const articleIds = preset[category];
        articleIds.forEach(articleId => {
          moveArticleToCenter(articleId, category);
        });
      }
    }

    // NEW function: "Start Again" resets the center column
    function startAgain() {
      clearCenter();
      // We also remove highlight from any leftover items, if needed
      document.querySelectorAll(".highlight-negotiation").forEach(li => {
        li.classList.remove("highlight-negotiation");
      });
      recalcRadarChart();
    }

    // Initial chart update
    recalcRadarChart();

    /***************************************************************************
     * 11. Revised "Optimize Draft" algorithm
     *
     *   1) Identify side with lower satisfaction (tie => Ukraine).
     *   2) totalCount = # articles in center. limitCount = floor(50% of totalCount).
     *   3) recommended[] = all articles from that side with pos=2 (negotiable).
     *   4) If recommended.length < limitCount, we fill from items with
     *      the highest (Ukraine_neg + Russia_neg), ignoring any already in recommended.
     *      (Optionally, also exclude any items that have pos=0 for the chosen side.)
     *   5) We highlight exactly up to limitCount items, in .highlight-negotiation.
     ***************************************************************************/

    function getCenterArticles() {
      const ids = [];
      document.querySelectorAll(".treaty-section ul li").forEach((li) => {
        const idStr = li.getAttribute("data-id");
        if (idStr) ids.push(parseInt(idStr, 10));
      });
      return ids;
    }

    function getStakeholdersData() {
      const centerIds = getCenterArticles();
      let sumUkSat = 0, sumRuSat = 0;
      const count = centerIds.length;
      centerIds.forEach((id) => {
        const info = articlesInfo[id];
        if (info) {
          sumUkSat += info.Ukraine_sat;
          sumRuSat += info.Russia_sat;
        }
      });
      return {
        UkraineAvg: count ? sumUkSat / count : 0,
        RussiaAvg:  count ? sumRuSat / count : 0
      };
    }

    function optimizeDraft() {
      // 1) Determine which side has lower satisfaction
      const { UkraineAvg, RussiaAvg } = getStakeholdersData();
      if (UkraineAvg === 0 && RussiaAvg === 0) {
        showErrorMessage("No articles in the draft to optimize.");
        return;
      }
      let selectedSide = "Ukraine";
      if (RussiaAvg < UkraineAvg) {
        selectedSide = "Russia";
      }
      // If tie => Ukraine

      // 2) Gather center articles
      const centerIds = getCenterArticles();
      const totalCount = centerIds.length;
      const limitCount = Math.floor(totalCount * 0.5);
      if (limitCount < 1) {
        showErrorMessage("Not enough articles in the draft.");
        return;
      }

      let posField, negField;
      if (selectedSide === "Ukraine") {
        posField = "Ukraine_pos";
        negField = "Ukraine_neg";
      } else {
        posField = "Russia_pos";
        negField = "Russia_neg";
      }

      // Start building recommended array
      // Step A: All center items for which side's pos != 0 (we skip items that side strongly opposes).
      const centerItems = centerIds.map(id => ({
        id,
        posUA: articlesInfo[id].Ukraine_pos,
        posRU: articlesInfo[id].Russia_pos,
        negUA: articlesInfo[id].Ukraine_neg,
        negRU: articlesInfo[id].Russia_neg
      }));
      // Filter out items that have pos=0 for the chosen side
      const sideFiltered = centerItems.filter(obj => {
        return selectedSide === "Ukraine"
          ? (obj.posUA !== 0)
          : (obj.posRU !== 0);
      });

      // Step B: from sideFiltered, pick those with pos=2 first
      let recommended = sideFiltered.filter(obj => {
        return selectedSide === "Ukraine"
          ? (obj.posUA === 2)
          : (obj.posRU === 2);
      });

      // Step C: If recommended still less than limitCount, fill from items with highest (UA_neg + RU_neg)
      if (recommended.length < limitCount) {
        // remaining pool is sideFiltered, excluding already recommended
        const recommendedIds = new Set(recommended.map(r => r.id));
        const remainingPool = sideFiltered.filter(obj => !recommendedIds.has(obj.id));
        
        // sort by sum(negUA + negRU) descending
        remainingPool.sort((a, b) => (b.negUA + b.negRU) - (a.negUA + a.negRU));
        
        for (let i=0; i<remainingPool.length && recommended.length < limitCount; i++) {
          recommended.push(remainingPool[i]);
        }
      }

      // 3) If recommended > limitCount, we can slice (though typically we won't exceed)
      // recommended = recommended.slice(0, limitCount);

      // 4) Unhighlight everything, then highlight recommended
      document.querySelectorAll(".treaty-section ul li").forEach(li => {
        li.classList.remove("highlight-negotiation");
      });
      recommended.forEach(item => {
        const li = document.querySelector(`.treaty-section ul li[data-id="${item.id}"]`);
        if (li) {
          li.classList.add("highlight-negotiation");
        }
      });

      // 5) Update chart (optional)
      recalcRadarChart();
    }
  </script>

</body>
</html>
